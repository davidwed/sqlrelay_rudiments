<html>
<head>
<title>firstworks   Programming with Rudiments using the Base Classes</title>
<link href="../css/styles.css" rel="stylesheet">
</head>
<body>

<span class="heading">Programming with Rudiments using the Base Classes</span><br><br>

<ul>
<li><a href="#daemon">Using the daemonprocess Class</a></li>
<li><a href="#filedescriptor">Using the filedescriptor Class</a></li>
<li><a href="#file">Using the file Class</a></li>
<li><a href="#device">Using the device Class</a></li>
<li><a href="#serialport">Using the serialport Class</a></li>
<li><a href="#shmfile">Using the shmfile Class</a></li>
<li><a href="#server">Using the Server Classes</a></li>
<li><a href="#client">Using the Client Classes</a></li>
<li><a href="#complex">Using the Complex Initialization methods of the Server Classes</a></li>
<li><a href="#listener">Using the listener Class</a></li>
</ul>

<a name="daemon"></a>
<span class="heading">Using the daemonprocess Class</span><br><br>

<p>Here is some sample code for a daemon process that writes "hello" every 2
seconds.  Most daemons don't write anything to the console, but this one does
for purposes of demonstration.</p>

<pre>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/daemonprocess.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;iostream&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;unistd.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;stdlib.h&gt;</font>

<font color="#a52a2a"><b>using</b></font> <font color="#2e8b57"><b>namespace</b></font> rudiments;
<font color="#a52a2a"><b>using</b></font> <font color="#2e8b57"><b>namespace</b></font> std;

<font color="#2e8b57"><b>class</b></font> mydaemon: <font color="#a52a2a"><b>public</b></font> daemonprocess {
        <font color="#a52a2a"><b>public</b></font>:
                <font color="#2e8b57"><b>void</b></font>    init();
                <font color="#2e8b57"><b>void</b></font>    loop();
};

<font color="#2e8b57"><b>void</b></font>    mydaemon::init() {
        runAsUser(<font color="#ff00ff">&quot;nobody&quot;</font>);
        runAsGroup(<font color="#ff00ff">&quot;nobody&quot;</font>);
        detach();
}

<font color="#2e8b57"><b>void</b></font>    mydaemon::loop() {
        <font color="#a52a2a"><b>for</b></font> (;;) {
                cout &lt;&lt; <font color="#ff00ff">&quot;hello&quot;</font> &lt;&lt; endl;
                sleep(<font color="#ff00ff">2</font>);
        }
}

mydaemon        *md;

<font color="#2e8b57"><b>void</b></font>    shutDown() {
        <font color="#a52a2a"><b>delete</b></font> md;
        exit(<font color="#ff00ff">0</font>);
}

main() {
        md=<font color="#a52a2a"><b>new</b></font> mydaemon;
        md-&gt;handleShutDown((<font color="#2e8b57"><b>void</b></font> *)shutDown);
        md-&gt;init();
        md-&gt;loop();
}
</pre>


<a name="#filedescriptor">
<span class="heading">Using the filedescriptor Class</span><br><br>

<p>...</p>

<a name="#file">
<span class="heading">Using the file Class</span><br><br>

<p>...</p>

<a name="#device">
<span class="heading">Using the device Class</span><br><br>

<p>...</p>

<a name="#serialport">
<span class="heading">Using the serialport Class</span><br><br>

<p>...</p>

<a name="#shmfile">
<span class="heading">Using the shmfile Class</span><br><br>

<p>...</p>

<a name="server"></a>
<span class="heading">Using the Server Classes</span><br><br>

<p>Daemons are commonly used to serve data to clients on the same machine or
over a network.  Below is an example combining the daemon and listener classes.
This server listens on unix and inet sockets for a client connection, receives
a string from the client and writes the same string back to the client.</p>

<PRE>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/daemonprocess.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/listener.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/unixserversocket.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/inetserversocket.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;unistd.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;stdlib.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;sys/stat.h&gt;</font>

<font color="#a52a2a"><b>using</b></font> <font color="#2e8b57"><b>namespace</b></font> rudiments;

<font color="#2e8b57"><b>class</b></font> myserver : <font color="#a52a2a"><b>public</b></font> daemonprocess, <font color="#a52a2a"><b>public</b></font> listener {
        <font color="#a52a2a"><b>public</b></font>:
                        myserver();
                        ~myserver();
                <font color="#2e8b57"><b>void</b></font>    loop();
                <font color="#2e8b57"><b>void</b></font>    session();
        <font color="#a52a2a"><b>private</b></font>:
                unixserversocket        inetsocket;
                inetserversocket        unixsocket;
                filedescriptor          *sock;
};

myserver::myserver() : daemonprocess(), listener() {

        <font color="#0000ff">// run as a different user/group</font>
        runAsUser(<font color="#ff00ff">&quot;nobody&quot;</font>);
        runAsGroup(<font color="#ff00ff">&quot;nobody&quot;</font>);

        <font color="#0000ff">// detach from the controlling tty</font>
        detach();

        <font color="#0000ff">// open, bind and listen on an inet port and unix socket</font>
        inetsocket.listen(<font color="#ff00ff">NULL</font>,<font color="#ff00ff">8040</font>,<font color="#ff00ff">15</font>);
        unixsocket.listen(<font color="#ff00ff">&quot;/tmp/mysocket&quot;</font>,S_IRUSR|S_IWUSR,<font color="#ff00ff">15</font>);

        <font color="#0000ff">// add the sockets to the pool</font>
        addFileDescriptor(&amp;inetsocket);
        addFileDescriptor(&amp;unixsocket);
}

myserver::~myserver() {
        inetsocket.close();
        unixsocket.close();
}

<font color="#2e8b57"><b>void</b></font>    myserver::loop() {

        <font color="#a52a2a"><b>for</b></font> (;;) {

                <font color="#0000ff">// accept connections, with no timeout</font>
                waitForNonBlockingRead(-<font color="#ff00ff">1</font>,-<font color="#ff00ff">1</font>);
                filedescriptor  *fd;
                getReadyList()-&gt;getDataByIndex(<font color="#ff00ff">0</font>,&amp;fd);

                <font color="#a52a2a"><b>if</b></font> (fd==&amp;inetsocket) {
                        sock=inetsocket.accept();
                } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (fd==&amp;unixsocket) {
                        sock=unixsocket.accept();
                }

                <font color="#0000ff">// fork to handle the new connection</font>
                <font color="#a52a2a"><b>if</b></font> (!fork()) {

                        <font color="#0000ff">// close the duplicated server socket,</font>
                        <font color="#0000ff">// engage in a session with the client,</font>
                        <font color="#0000ff">// close the client socket and exit</font>
                        <font color="#a52a2a"><b>if</b></font> (fd==&amp;inetsocket) {
                                inetsocket.close();
                        } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (fd==&amp;unixsocket) {
                                unixsocket.close();
                        }
                        session();
                        sock-&gt;close();
                        _exit(<font color="#ff00ff">0</font>);
                }

                <font color="#0000ff">// close the client socket, but leave the server</font>
                <font color="#0000ff">// socket open to accept more connections</font>
                <font color="#a52a2a"><b>if</b></font> (fd==&amp;inetsocket) {
                        inetsocket.close();
                } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (fd==&amp;unixsocket) {
                        unixsocket.close();
                }
        }
}

<font color="#2e8b57"><b>void</b></font>    myserver::session() {

        <font color="#0000ff">// read a string from the client</font>
        <font color="#2e8b57"><b>short</b></font>   bytes;
        sock-&gt;read(&amp;bytes);
        <font color="#2e8b57"><b>char</b></font>    *string=<font color="#a52a2a"><b>new</b></font> <font color="#2e8b57"><b>char</b></font>[bytes+<font color="#ff00ff">1</font>];
        sock-&gt;read(string,bytes);

        <font color="#0000ff">// write the same string back to the client</font>
        sock-&gt;write(bytes);
        sock-&gt;write(string,bytes);

        <font color="#0000ff">// clean up</font>
        <font color="#a52a2a"><b>delete</b></font>[] string;
}


myserver        *ms;

<font color="#2e8b57"><b>void</b></font>    shutDown() {
        <font color="#a52a2a"><b>delete</b></font> ms;
        exit(<font color="#ff00ff">0</font>);
}

main() {
        ms=<font color="#a52a2a"><b>new</b></font> myserver();
        ms-&gt;handleShutDown((<font color="#2e8b57"><b>void</b></font> *)shutDown);
        ms-&gt;loop();
}
</PRE>

<p>Notice that this server listens on both inet and unix ports.  Inet ports
allow clients and servers to talk across a network.  Unix ports allow clients
and servers on the same machine to talk through a pipe.  Though clients and
servers on the same machine could talk over inet ports, unix ports are much
faster and use fewer system resources.</p>

<a name="client"></a>
<span class="heading">Using the Client Classes</span><br><br>

<p>Here's the code for a client that can talk to the server above.  This client
sends a string to the server, reads what the server sends back and prints it
out.  It does this once over an inet port and once over a unix port.</p>

<pre>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/inetclientsocket.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/unixclientsocket.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;iostream&gt;</font>

<font color="#a52a2a"><b>using</b></font> <font color="#2e8b57"><b>namespace</b></font> rudiments;
<font color="#a52a2a"><b>using</b></font> <font color="#2e8b57"><b>namespace</b></font> std;

<font color="#2e8b57"><b>class</b></font> myclient {
        <font color="#a52a2a"><b>public</b></font>:
                <font color="#2e8b57"><b>void</b></font>    inetSession(<font color="#2e8b57"><b>char</b></font> *host, <font color="#2e8b57"><b>int</b></font> port, <font color="#2e8b57"><b>char</b></font> *message);
                <font color="#2e8b57"><b>void</b></font>    unixSession(<font color="#2e8b57"><b>char</b></font> *socket, <font color="#2e8b57"><b>char</b></font> *message);
        <font color="#a52a2a"><b>private</b></font>:
                <font color="#2e8b57"><b>void</b></font>    session(filedescriptor *sock, <font color="#2e8b57"><b>char</b></font> *message);
                inetclientsocket        inetsock;
                unixclientsocket        unixsock;
};

<font color="#2e8b57"><b>void</b></font>    myclient::inetSession(<font color="#2e8b57"><b>char</b></font> *host, <font color="#2e8b57"><b>int</b></font> port, <font color="#2e8b57"><b>char</b></font> *message) {
        inetsock.connect(host,port,-<font color="#ff00ff">1</font>,-<font color="#ff00ff">1</font>,<font color="#ff00ff">0</font>,<font color="#ff00ff">1</font>);
        session(&amp;inetsock,message);
}

<font color="#2e8b57"><b>void</b></font>    myclient::unixSession(<font color="#2e8b57"><b>char</b></font> *socket, <font color="#2e8b57"><b>char</b></font> *message) {
        unixsock.connect(socket,-<font color="#ff00ff">1</font>,-<font color="#ff00ff">1</font>,<font color="#ff00ff">0</font>,<font color="#ff00ff">1</font>);
        session(&amp;unixsock,message);
}

<font color="#2e8b57"><b>void</b></font>    myclient::session(filedescriptor *sock, <font color="#2e8b57"><b>char</b></font> *message) {

        <font color="#0000ff">// write a message to the server</font>
        sock-&gt;write((<font color="#2e8b57"><b>short</b></font>)strlen(message));
        sock-&gt;write(message);

        <font color="#0000ff">// read a message back from the server</font>
        <font color="#2e8b57"><b>short</b></font>   bytes;
        sock-&gt;read(&amp;bytes);
        <font color="#2e8b57"><b>char</b></font>    *string=<font color="#a52a2a"><b>new</b></font> <font color="#2e8b57"><b>char</b></font>[bytes+<font color="#ff00ff">1</font>];
        sock-&gt;read(string,bytes);

        <font color="#0000ff">// write out the message we got from the server</font>
        cout &lt;&lt; string &lt;&lt; endl;

        <font color="#0000ff">// clean up</font>
        <font color="#a52a2a"><b>delete</b></font>[] string;
}

main() {

        <font color="#0000ff">// declare an instance of our client</font>
        myclient        mc;

        <font color="#0000ff">// connect to a known inet host/port and unix socket and </font>
        <font color="#0000ff">// send a message over each connection</font>
        mc.inetSession(<font color="#ff00ff">&quot;localhost&quot;</font>,<font color="#ff00ff">8040</font>,<font color="#ff00ff">&quot;message over inet port&quot;</font>);
        mc.unixSession(<font color="#ff00ff">&quot;/tmp/mysocket&quot;</font>,<font color="#ff00ff">&quot;message over unix port&quot;</font>);
}
</pre>

<a name="complex"></a>
<span class="heading">Using the Complex Initialization methods of the
Server Classes</span><br><br>

<p>Setting up a server to listen on a socket is actually a multi-step process. 
The listen() methods simplify this process but some applications may
require a more flexible interface.  If you need to set socket options or
perform additional actions between the steps of socket initialization, you can
use the Complex Inititalization methods of the server classes.</p>

<p>Below is an alternative implementation of the myserver constructor in
which some socket options are set.</p>

<pre>
myserver::myserver() : daemonprocess(), listener() {

        <font color="#0000ff">// run as a different user/group</font>
        runAsUser(<font color="#ff00ff">&quot;nobody&quot;</font>);
        runAsGroup(<font color="#ff00ff">&quot;nobody&quot;</font>);

        <font color="#0000ff">// detach from the controlling tty</font>
        detach();

        <font color="#0000ff">// initialize the ports</font>
        inetsocket.initialize(<font color="#ff00ff">NULL</font>,<font color="#ff00ff">8040</font>);
        unixsocket.initialize(<font color="#ff00ff">&quot;/tmp/mysocket&quot;</font>,S_IRUSR|S_IWUSR);

        <font color="#0000ff">// set some socket options</font>
        inetsocket.lingerOnClose(<font color="#ff00ff">10</font>);
        inetsocket.reuseAddresses();
        unixsocket.lingerOnClose(<font color="#ff00ff">10</font>);

        <font color="#0000ff">// bind to the ports</font>
        inetsocket.bind();
        unixsocket.bind();

        <font color="#0000ff">// listen on the ports</font>
        inetsocket.listen(<font color="#ff00ff">15</font>);
        unixsocket.listen(<font color="#ff00ff">15</font>);

        <font color="#0000ff">// add sockets to the pool</font>
        addFileDescriptor(&amp;inetsocket);
        addFileDescriptor(&amp;unixsocket);
}
</pre>

<a name="#listener">
<span class="heading">Using the listener Class</span><br><br>

<p>...</p>

</body>
</html>
