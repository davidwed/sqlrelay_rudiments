<html>
<head>
<title>firstworks   Programming with Rudiments using the Base Classes</title>
<link href="../css/styles.css" rel="stylesheet">
</head>
<body>

<span class="heading">Programming with Rudiments using the Base Classes</span><br><br>

<ul>
<li><a href="#daemon">Using the daemonprocess Class</a></li>
<li><a href="#filedescriptor">Using the filedescriptor Class</a></li>
<li><a href="#file">Using the file Class</a></li>
<li><a href="#device">Using the device Class</a></li>
<li><a href="#serialport">Using the serialport Class</a></li>
<li><a href="#shmfile">Using the shmfile Class</a></li>
<li><a href="#server">Using the Server Classes</a></li>
<li><a href="#client">Using the Client Classes</a></li>
<li><a href="#complex">Using the Complex Initialization methods of the Server Classes</a></li>
<li><a href="#listener">Using the listener Class</a></li>
</ul>

<a name="daemon"></a>
<span class="heading">Using the daemonprocess Class</span><br><br>

<p>Here is some sample code for a daemon process that writes "hello" every 2
seconds.  Most daemons don't write anything to the console, but this one does
for purposes of demonstration.</p>








<pre>
<font color="#0000ff">// Copyright (c) 2001  David Muse</font>
<font color="#0000ff">// See the file COPYING for more information</font>

<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/daemonprocess.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/permissions.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/process.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/file.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/snooze.h&gt;</font>

<font color="#a020f0">#include </font><font color="#ff00ff">&lt;stdlib.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;sys/types.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;unistd.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;stdio.h&gt;</font>

<font color="#a020f0">#ifdef RUDIMENTS_NAMESPACE</font>
<font color="#a52a2a"><b>using</b></font> <font color="#2e8b57"><b>namespace</b></font> rudiments;
<font color="#a020f0">#endif</font>

daemonprocess   *dmn;

<font color="#0000ff">// define a function to shut down the process cleanly</font>
RETSIGTYPE      shutDown() {

        printf(<font color="#ff00ff">&quot;</font><font color="#6a5acd">%d</font><font color="#ff00ff">: shutting down</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,process::getProcessId());

        <font color="#0000ff">// clean up</font>
        <font color="#a52a2a"><b>delete</b></font> dmn;
        file::remove(<font color="#ff00ff">&quot;/tmp/dmn.pidfile&quot;</font>);
        exit(<font color="#ff00ff">0</font>);
}

<font color="#2e8b57"><b>int</b></font> main(<font color="#2e8b57"><b>int</b></font> argc, <font color="#2e8b57"><b>const</b></font> <font color="#2e8b57"><b>char</b></font> **argv) {

        dmn=<font color="#a52a2a"><b>new</b></font> daemonprocess();

        <font color="#0000ff">// set up signal handlers for clean shutdown</font>
        dmn-&gt;handleShutDown((RETSIGTYPE *)shutDown);
        dmn-&gt;handleCrash((RETSIGTYPE *)shutDown);

        <font color="#0000ff">// change the user/group that the daemon is running as</font>
        dmn-&gt;runAsUser(<font color="#ff00ff">&quot;nobody&quot;</font>);
        dmn-&gt;runAsGroup(<font color="#ff00ff">&quot;nobody&quot;</font>);

        <font color="#0000ff">// make sure that only one instance is running</font>
        <font color="#2e8b57"><b>int</b></font>    pid=dmn-&gt;checkForPidFile(<font color="#ff00ff">&quot;/tmp/dmn.pidfile&quot;</font>);
        <font color="#a52a2a"><b>if</b></font> (pid&gt;-<font color="#ff00ff">1</font>) {
                printf(<font color="#ff00ff">&quot;Sorry, an instance of this daemon is already running with process id: </font><font color="#6a5acd">%d</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,pid);
                <font color="#a52a2a"><b>delete</b></font> dmn;
                exit(<font color="#ff00ff">0</font>);
        }

        <font color="#0000ff">// detach from the controlling terminal</font>
        dmn-&gt;detach();

        <font color="#0000ff">// create a pid file which is used to make sure that only one instance</font>
        <font color="#0000ff">// is running and can also be used to kill the process</font>
        dmn-&gt;createPidFile(<font color="#ff00ff">&quot;/tmp/dmn.pidfile&quot;</font>,permissions::ownerReadWrite());

        <font color="#a52a2a"><b>if</b></font> (!fork()) {
                <font color="#a52a2a"><b>for</b></font> (;;) {
                        printf(<font color="#ff00ff">&quot;</font><font color="#6a5acd">%d</font><font color="#ff00ff">: child looping...</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,
                                process::getProcessId());
                        snooze::macrosnooze(<font color="#ff00ff">1</font>);
                }
        }

        <font color="#0000ff">// loop, printing &quot;looping...&quot; once per second</font>
        <font color="#a52a2a"><b>for</b></font> (;;) {
                printf(<font color="#ff00ff">&quot;</font><font color="#6a5acd">%d</font><font color="#ff00ff">: parent looping...</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,
                                process::getProcessId());
                snooze::macrosnooze(<font color="#ff00ff">1</font>);
        }
}
</pre>



<a name="#filedescriptor">
<span class="heading">Using the filedescriptor Class</span><br><br>

<p>...</p>


<a name="#file">
<span class="heading">Using the file Class</span><br><br>

<p>...</p>








<pre>
<font color="#0000ff">// Copyright (c) 2003  David Muse</font>
<font color="#0000ff">// See the file COPYING for more information</font>

<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/groupentry.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/passwdentry.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/file.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/permissions.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/datetime.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;stdio.h&gt;</font>

<font color="#a020f0">#ifdef RUDIMENTS_NAMESPACE</font>
<font color="#a52a2a"><b>using</b></font> <font color="#2e8b57"><b>namespace</b></font> rudiments;
<font color="#a020f0">#endif</font>

<font color="#2e8b57"><b>int</b></font> main(<font color="#2e8b57"><b>int</b></font> argc, <font color="#2e8b57"><b>const</b></font> <font color="#2e8b57"><b>char</b></font> **argv) {


        <font color="#0000ff">// remove the file (in case it already exists)</font>
        file::remove(<font color="#ff00ff">&quot;testfile&quot;</font>);


        <font color="#0000ff">// create a new file called &quot;testfile&quot; with rw-rw---- permissions</font>
        <font color="#0000ff">// and initial contents &quot;hello&quot;</font>
        file    fl;
        fl.create(<font color="#ff00ff">&quot;testfile&quot;</font>,permissions::evalPermString(<font color="#ff00ff">&quot;rw-rw----&quot;</font>),<font color="#ff00ff">&quot;hello&quot;</font>);

        printf(<font color="#ff00ff">&quot;testfile:</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>);

        <font color="#0000ff">// check for existence</font>
        <font color="#a52a2a"><b>if</b></font> (file::exists(<font color="#ff00ff">&quot;testfile&quot;</font>)) {
                printf(<font color="#ff00ff">&quot;      exists</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>);
        } <font color="#a52a2a"><b>else</b></font> {
                printf(<font color="#ff00ff">&quot;      does not exist</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>);
        }

        <font color="#0000ff">// display the permissions of the file</font>
        mode_t  mode=fl.getPermissions();
        printf(<font color="#ff00ff">&quot;       permissions: </font><font color="#6a5acd">%s</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,permissions::evalPermOctal(mode));


        <font color="#0000ff">// display the name of the user that owns the file</font>
        uid_t   uid=fl.getOwnerUserId();
        <font color="#2e8b57"><b>char</b></font>   *username;
        passwdentry::getName(uid,&amp;username);
        printf(<font color="#ff00ff">&quot;       user       : </font><font color="#6a5acd">%s</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,username);
        <font color="#a52a2a"><b>delete</b></font>[] username;


        <font color="#0000ff">// display the name of the group that owns the file</font>
        gid_t   gid=fl.getOwnerGroupId();
        <font color="#2e8b57"><b>char</b></font>   *groupname;
        groupentry::getName(gid,&amp;groupname);
        printf(<font color="#ff00ff">&quot;       group      : </font><font color="#6a5acd">%s</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,groupname);
        <font color="#a52a2a"><b>delete</b></font>[] groupname;


        <font color="#0000ff">// display the size of the file in bytes</font>
        off64_t size=fl.getSize();
        printf(<font color="#ff00ff">&quot;       size       : </font><font color="#6a5acd">%ld</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,size);


        <font color="#0000ff">// display the size of the file in blocks</font>
        blkcnt_t        blocks=fl.getBlockCount();
        printf(<font color="#ff00ff">&quot;       blocks     : </font><font color="#6a5acd">%ld</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,blocks);


        <font color="#0000ff">// display the file type</font>
        printf(<font color="#ff00ff">&quot;       is a socket: </font><font color="#6a5acd">%d</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,fl.isSocket());
        printf(<font color="#ff00ff">&quot;       is a symlink: </font><font color="#6a5acd">%d</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,fl.isSymbolicLink());
        printf(<font color="#ff00ff">&quot;       is a regular file: </font><font color="#6a5acd">%d</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,fl.isRegularFile());
        printf(<font color="#ff00ff">&quot;       is a block device: </font><font color="#6a5acd">%d</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,fl.isBlockDevice());
        printf(<font color="#ff00ff">&quot;       is a directory: </font><font color="#6a5acd">%d</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,fl.isDirectory());
        printf(<font color="#ff00ff">&quot;       is a character device: </font><font color="#6a5acd">%d</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,fl.isCharacterDevice());
        printf(<font color="#ff00ff">&quot;       is a fifo: </font><font color="#6a5acd">%d</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,fl.isFifo());


        <font color="#0000ff">// display the last time the file was accessed</font>
        <font color="#2e8b57"><b>time_t</b></font> atime=fl.getLastAccessTime();
        <font color="#2e8b57"><b>char</b></font>   *atimestr=datetime::getString(atime);
        printf(<font color="#ff00ff">&quot;       last access      : </font><font color="#6a5acd">%s</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,atimestr);
        <font color="#a52a2a"><b>delete</b></font>[] atimestr;


        <font color="#0000ff">// display the last time the file was modified</font>
        <font color="#2e8b57"><b>time_t</b></font> mtime=fl.getLastModificationTime();
        <font color="#2e8b57"><b>char</b></font>   *mtimestr=datetime::getString(mtime);
        printf(<font color="#ff00ff">&quot;       last modification: </font><font color="#6a5acd">%s</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,mtimestr);
        <font color="#a52a2a"><b>delete</b></font>[] mtimestr;


        <font color="#0000ff">// display the last time the file was changed</font>
        <font color="#2e8b57"><b>time_t</b></font> ctime=fl.getLastChangeTime();
        <font color="#2e8b57"><b>char</b></font>   *ctimestr=datetime::getString(ctime);
        printf(<font color="#ff00ff">&quot;       last change      : </font><font color="#6a5acd">%s</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,ctimestr);
        <font color="#a52a2a"><b>delete</b></font>[] ctimestr;


        <font color="#0000ff">// display the device that the file resides on</font>
        dev_t   dev=fl.getDevice();
        printf(<font color="#ff00ff">&quot;       device           : </font><font color="#6a5acd">%d</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,dev);


        <font color="#0000ff">// display the type of the device that the file resides on</font>
        dev_t   devtype=fl.getDeviceType();
        printf(<font color="#ff00ff">&quot;       device type      : </font><font color="#6a5acd">%d</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,devtype);


        <font color="#0000ff">// display the file's first inode</font>
        ino_t   inode=fl.getInode();
        printf(<font color="#ff00ff">&quot;       inode            : </font><font color="#6a5acd">%d</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,inode);


        <font color="#0000ff">// display the number of hard links to the file</font>
        nlink_t nlink=fl.getNumberOfHardLinks();
        printf(<font color="#ff00ff">&quot;       hard links : </font><font color="#6a5acd">%ld</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,nlink);


        <font color="#2e8b57"><b>char</b></font>   *path=<font color="#ff00ff">&quot;/usr/local/firstworks/include/rudiments/file.h&quot;</font>;
        <font color="#2e8b57"><b>char</b></font>   *dirname=file::dirname(path);
        printf(<font color="#ff00ff">&quot;dirname(</font><font color="#6a5acd">%s</font><font color="#ff00ff">)=</font><font color="#6a5acd">%s</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,path,dirname);
        <font color="#a52a2a"><b>delete</b></font>[] dirname;

        <font color="#2e8b57"><b>char</b></font>   *basename=file::basename(path);
        printf(<font color="#ff00ff">&quot;basename(</font><font color="#6a5acd">%s</font><font color="#ff00ff">)=</font><font color="#6a5acd">%s</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,path,basename);
        <font color="#a52a2a"><b>delete</b></font>[] basename;

        basename=file::basename(path,<font color="#ff00ff">&quot;.h&quot;</font>);
        printf(<font color="#ff00ff">&quot;basename(</font><font color="#6a5acd">%s</font><font color="#ff00ff">,</font><font color="#6a5acd">\&quot;</font><font color="#ff00ff">.h</font><font color="#6a5acd">\&quot;</font><font color="#ff00ff">)=</font><font color="#6a5acd">%s</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,path,basename);
        <font color="#a52a2a"><b>delete</b></font>[] basename;

        printf(<font color="#ff00ff">&quot;key=</font><font color="#6a5acd">%d</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,file::generateKey(<font color="#ff00ff">&quot;/&quot;</font>,<font color="#ff00ff">1</font>));

        printf(<font color="#ff00ff">&quot;maxLinks(</font><font color="#6a5acd">%s</font><font color="#ff00ff">)=</font><font color="#6a5acd">%d</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,path,file::maxLinks(path));

        printf(<font color="#ff00ff">&quot;canChangeOwner(</font><font color="#6a5acd">%s</font><font color="#ff00ff">)=</font><font color="#6a5acd">%d</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,path,file::canChangeOwner(path));
}
</pre>



<a name="#device">
<span class="heading">Using the device Class</span><br><br>

<p>...</p>


<a name="#serialport">
<span class="heading">Using the serialport Class</span><br><br>

<p>...</p>


<a name="#shmfile">
<span class="heading">Using the shmfile Class</span><br><br>

<p>...</p>


<a name="server"></a>
<span class="heading">Using the Server Classes</span><br><br>

<p>Daemons are commonly used to serve data to clients on the same machine or
over a network.  Below is an example combining the daemon and listener classes.
This server listens on unix and inet sockets for a client connection, receives
a string from the client and writes the same string back to the client.</p>








<pre>
<font color="#0000ff">// Copyright (c) 2001  David Muse</font>
<font color="#0000ff">// See the file COPYING for more information</font>

<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/daemonprocess.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/permissions.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/inetserversocket.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/file.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;stdio.h&gt;</font>

<font color="#a020f0">#ifdef RUDIMENTS_NAMESPACE</font>
<font color="#a52a2a"><b>using</b></font> <font color="#2e8b57"><b>namespace</b></font> rudiments;
<font color="#a020f0">#endif</font>

<font color="#2e8b57"><b>class</b></font> myserver : <font color="#a52a2a"><b>public</b></font> daemonprocess, <font color="#a52a2a"><b>public</b></font> inetserversocket {
        <font color="#a52a2a"><b>public</b></font>:
                        myserver() : daemonprocess(), inetserversocket() {}
                <font color="#2e8b57"><b>void</b></font>  listen();
};


<font color="#2e8b57"><b>void</b></font>    myserver::listen() {


        <font color="#0000ff">// make sure that only one instance is running</font>
        <font color="#2e8b57"><b>int</b></font>    pid=checkForPidFile(<font color="#ff00ff">&quot;/tmp/svr.pidfile&quot;</font>);
        <font color="#a52a2a"><b>if</b></font> (pid&gt;-<font color="#ff00ff">1</font>) {
                printf(<font color="#ff00ff">&quot;Sorry, an instance of this server is already running with process id: </font><font color="#6a5acd">%d</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,pid);
                <font color="#a52a2a"><b>return</b></font>;
        }


        <font color="#0000ff">// detach from the controlling terminal</font>
        <font color="#0000ff">//detach();</font>


        <font color="#0000ff">// create a pid file which is used to make sure that only one instance</font>
        <font color="#0000ff">// is running and can also be used to kill the process</font>
        createPidFile(<font color="#ff00ff">&quot;/tmp/svr.pidfile&quot;</font>,permissions::ownerReadWrite());


        <font color="#0000ff">// listen on inet socket port 8000</font>
        <font color="#a52a2a"><b>if</b></font> (!inetserversocket::listen(<font color="#ff00ff">NULL</font>,<font color="#ff00ff">8000</font>,<font color="#ff00ff">15</font>)) {
                printf(<font color="#ff00ff">&quot;couldn't listen on port 8000</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>);
        }


        <font color="#0000ff">// loop...</font>
        <font color="#a52a2a"><b>for</b></font> (;;) {

                <font color="#0000ff">// accept a client connection</font>
                filedescriptor  *clientsock=accept();

                <font color="#0000ff">// read 5 bytes from the client and display it</font>
                <font color="#2e8b57"><b>char</b></font>  buffer[<font color="#ff00ff">6</font>];
                buffer[<font color="#ff00ff">5</font>]=(<font color="#2e8b57"><b>char</b></font>)<font color="#ff00ff">NULL</font>;
                clientsock-&gt;read((<font color="#2e8b57"><b>char</b></font> *)buffer,<font color="#ff00ff">5</font>);
                printf(<font color="#ff00ff">&quot;</font><font color="#6a5acd">%s</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,buffer);

                <font color="#0000ff">// write &quot;hello&quot; back to the client</font>
                clientsock-&gt;write(<font color="#ff00ff">&quot;hello&quot;</font>,<font color="#ff00ff">5</font>);

                <font color="#0000ff">// close the socket and clean up</font>
                clientsock-&gt;close();
                <font color="#a52a2a"><b>delete</b></font> clientsock;
        }
}


myserver        *mysvr;

<font color="#0000ff">// define a function to shut down the process cleanly</font>
RETSIGTYPE      shutDown() {
        printf(<font color="#ff00ff">&quot;shutting down</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>);
        mysvr-&gt;close();
        <font color="#a52a2a"><b>delete</b></font> mysvr;
        file::remove(<font color="#ff00ff">&quot;/tmp/svr.pidfile&quot;</font>);
        exit(<font color="#ff00ff">0</font>);
}


<font color="#2e8b57"><b>int</b></font> main(<font color="#2e8b57"><b>int</b></font> argc, <font color="#2e8b57"><b>const</b></font> <font color="#2e8b57"><b>char</b></font> **argv) {

        mysvr=<font color="#a52a2a"><b>new</b></font> myserver();

        <font color="#0000ff">// set up signal handlers for clean shutdown</font>
        mysvr-&gt;handleShutDown((RETSIGTYPE *)shutDown);
        mysvr-&gt;handleCrash((RETSIGTYPE *)shutDown);

        mysvr-&gt;listen();
}
</pre>



<p>Notice that this server listens on both inet and unix ports.  Inet ports
allow clients and servers to talk across a network.  Unix ports allow clients
and servers on the same machine to talk through a pipe.  Though clients and
servers on the same machine could talk over inet ports, unix ports are much
faster and use fewer system resources.</p>

<a name="client"></a>
<span class="heading">Using the Client Classes</span><br><br>

<p>Here's the code for a client that can talk to the server above.  This client
sends a string to the server, reads what the server sends back and prints it
out.  It does this once over an inet port and once over a unix port.</p>








<pre>
<font color="#0000ff">// Copyright (c) 2001  David Muse</font>
<font color="#0000ff">// See the file COPYING for more information</font>

<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/inetclientsocket.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;stdio.h&gt;</font>

<font color="#a020f0">#ifdef RUDIMENTS_NAMESPACE</font>
<font color="#a52a2a"><b>using</b></font> <font color="#2e8b57"><b>namespace</b></font> rudiments;
<font color="#a020f0">#endif</font>

<font color="#2e8b57"><b>int</b></font> main(<font color="#2e8b57"><b>int</b></font> argc, <font color="#2e8b57"><b>const</b></font> <font color="#2e8b57"><b>char</b></font> **argv) {

        <font color="#0000ff">// create an inet socket client</font>
        inetclientsocket        clnt;

        <font color="#0000ff">// connect to a server on localhost, listening on port 8000</font>
        <font color="#a52a2a"><b>if</b></font> (clnt.connect(<font color="#ff00ff">&quot;localhost&quot;</font>,<font color="#ff00ff">8000</font>,-<font color="#ff00ff">1</font>,-<font color="#ff00ff">1</font>,<font color="#ff00ff">1</font>,<font color="#ff00ff">1</font>)&lt;<font color="#ff00ff">0</font>) {
                printf(<font color="#ff00ff">&quot;connect failed: </font><font color="#6a5acd">%s</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,error::getErrorString());
                exit(<font color="#ff00ff">1</font>);
        }

        <font color="#0000ff">// write &quot;hello&quot; to the server</font>
        clnt.write(<font color="#ff00ff">&quot;hello&quot;</font>,<font color="#ff00ff">5</font>);

        <font color="#0000ff">// read 10 bytes from the server and display them</font>
        <font color="#2e8b57"><b>char</b></font>   buffer[<font color="#ff00ff">11</font>];
        <font color="#2e8b57"><b>int</b></font>    sizeread=clnt.read(buffer,<font color="#ff00ff">10</font>);
        buffer[sizeread]=(<font color="#2e8b57"><b>char</b></font>)<font color="#ff00ff">NULL</font>;
        printf(<font color="#ff00ff">&quot;</font><font color="#6a5acd">%s</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,buffer);

        <font color="#0000ff">// close the connection to the server</font>
        clnt.close();
}
</pre>










<pre>
<font color="#0000ff">// Copyright (c) 2001  David Muse</font>
<font color="#0000ff">// See the file COPYING for more information</font>

<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/unixclientsocket.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/error.h&gt;</font>

<font color="#a020f0">#ifdef RUDIMENTS_NAMESPACE</font>
<font color="#a52a2a"><b>using</b></font> <font color="#2e8b57"><b>namespace</b></font> rudiments;
<font color="#a020f0">#endif</font>

<font color="#2e8b57"><b>int</b></font> main(<font color="#2e8b57"><b>int</b></font> argc, <font color="#2e8b57"><b>const</b></font> <font color="#2e8b57"><b>char</b></font> **argv) {

        <font color="#0000ff">// create a unix socket client</font>
        unixclientsocket        clnt;

        <font color="#0000ff">// connect to a server listening on /tmp/lsnr.socket</font>
        <font color="#a52a2a"><b>if</b></font> (clnt.connect(<font color="#ff00ff">&quot;/tmp/lsnr.socket&quot;</font>,-<font color="#ff00ff">1</font>,-<font color="#ff00ff">1</font>,<font color="#ff00ff">1</font>,<font color="#ff00ff">1</font>)&lt;<font color="#ff00ff">0</font>) {
                printf(<font color="#ff00ff">&quot;connect failed: </font><font color="#6a5acd">%s</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,error::getErrorString());
                exit(<font color="#ff00ff">0</font>);
        }

        <font color="#0000ff">// write &quot;hello&quot; to the server</font>
        clnt.write(<font color="#ff00ff">&quot;hello&quot;</font>,<font color="#ff00ff">5</font>);

        <font color="#0000ff">// read 10 bytes from the server and display them</font>
        <font color="#2e8b57"><b>char</b></font>   buffer[<font color="#ff00ff">11</font>];
        <font color="#2e8b57"><b>int</b></font>    sizeread=clnt.read(buffer,<font color="#ff00ff">10</font>);
        buffer[sizeread]=(<font color="#2e8b57"><b>char</b></font>)<font color="#ff00ff">NULL</font>;
        printf(<font color="#ff00ff">&quot;</font><font color="#6a5acd">%s</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,buffer);

        <font color="#0000ff">// close the connection to the server</font>
        clnt.close();
}
</pre>



<a name="complex"></a>
<span class="heading">Using the Complex Initialization methods of the
Server Classes</span><br><br>

<p>Setting up a server to listen on a socket is actually a multi-step process. 
The listen() methods simplify this process but some applications may
require a more flexible interface.  If you need to set socket options or
perform additional actions between the steps of socket initialization, you can
use the Complex Inititalization methods of the server classes.</p>

<p>Below is an alternative implementation of the myserver constructor in
which some socket options are set.</p>

<pre>
myserver::myserver() : daemonprocess(), listener() {

        <font color="#0000ff">// run as a different user/group</font>
        runAsUser(<font color="#ff00ff">&quot;nobody&quot;</font>);
        runAsGroup(<font color="#ff00ff">&quot;nobody&quot;</font>);

        <font color="#0000ff">// detach from the controlling tty</font>
        detach();

        <font color="#0000ff">// initialize the ports</font>
        inetsocket.initialize(<font color="#ff00ff">NULL</font>,<font color="#ff00ff">8040</font>);
        unixsocket.initialize(<font color="#ff00ff">&quot;/tmp/mysocket&quot;</font>,S_IRUSR|S_IWUSR);

        <font color="#0000ff">// set some socket options</font>
        inetsocket.lingerOnClose(<font color="#ff00ff">10</font>);
        inetsocket.reuseAddresses();
        unixsocket.lingerOnClose(<font color="#ff00ff">10</font>);

        <font color="#0000ff">// bind to the ports</font>
        inetsocket.bind();
        unixsocket.bind();

        <font color="#0000ff">// listen on the ports</font>
        inetsocket.listen(<font color="#ff00ff">15</font>);
        unixsocket.listen(<font color="#ff00ff">15</font>);

        <font color="#0000ff">// add sockets to the pool</font>
        addFileDescriptor(&amp;inetsocket);
        addFileDescriptor(&amp;unixsocket);
}
</pre>

<a name="#listener">
<span class="heading">Using the listener Class</span><br><br>

<p>...</p>








<pre>
<font color="#0000ff">// Copyright (c) 2001  David Muse</font>
<font color="#0000ff">// See the file COPYING for more information</font>

<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/listener.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/inetserversocket.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/unixserversocket.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/permissions.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;stdio.h&gt;</font>

<font color="#a020f0">#ifdef RUDIMENTS_NAMESPACE</font>
<font color="#a52a2a"><b>using</b></font> <font color="#2e8b57"><b>namespace</b></font> rudiments;
<font color="#a020f0">#endif</font>

<font color="#2e8b57"><b>int</b></font> main(<font color="#2e8b57"><b>int</b></font> argc, <font color="#2e8b57"><b>const</b></font> <font color="#2e8b57"><b>char</b></font> **argv) {


        <font color="#0000ff">// listen on inet socket port 1800</font>
        inetserversocket        inetsock;
        <font color="#a52a2a"><b>if</b></font> (!inetsock.listen(<font color="#ff00ff">NULL</font>,<font color="#ff00ff">8000</font>,<font color="#ff00ff">15</font>)) {
                printf(<font color="#ff00ff">&quot;couldn't listen on inet socket</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>);
        }


        <font color="#0000ff">// listen on unix socket &quot;/tmp/lsnr.socket&quot;</font>
        unixserversocket        unixsock;
        <font color="#a52a2a"><b>if</b></font> (!unixsock.listen(<font color="#ff00ff">&quot;/tmp/lsnr.socket&quot;</font>,<font color="#a020f0">0</font><font color="#ff00ff">000</font>,<font color="#ff00ff">15</font>)) {
                printf(<font color="#ff00ff">&quot;couldn't listen on unix socket</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>);
        }


        <font color="#0000ff">// create a listener and add the 2 sockets to it</font>
        listener        pool;
        pool.addFileDescriptor(&amp;inetsock);
        pool.addFileDescriptor(&amp;unixsock);


        <font color="#0000ff">// loop...</font>
        <font color="#a52a2a"><b>for</b></font> (;;) {

                <font color="#0000ff">// wait for a client to connect to one of the sockets</font>
                pool.waitForNonBlockingRead(-<font color="#ff00ff">1</font>,-<font color="#ff00ff">1</font>);
                filedescriptor  *fd=<font color="#ff00ff">NULL</font>;
                pool.getReadyList()-&gt;getDataByIndex(<font color="#ff00ff">0</font>,&amp;fd);

                <font color="#0000ff">// figure out which socket the client connected to</font>
                filedescriptor  *clientsock;
                <font color="#a52a2a"><b>if</b></font> (fd==&amp;inetsock) {
                        clientsock=inetsock.accept();
                        printf(<font color="#ff00ff">&quot;inetsock: &quot;</font>);
                } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (fd==&amp;unixsock) {
                        clientsock=unixsock.accept();
                        printf(<font color="#ff00ff">&quot;unixsock: &quot;</font>);
                } <font color="#a52a2a"><b>else</b></font> {
                        printf(<font color="#ff00ff">&quot;error or timeout waiting...</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>);
                        <font color="#a52a2a"><b>continue</b></font>;
                }


                <font color="#0000ff">// read 5 bytes from the client and display it</font>
                <font color="#2e8b57"><b>char</b></font>  buffer[<font color="#ff00ff">6</font>];
                buffer[<font color="#ff00ff">5</font>]=(<font color="#2e8b57"><b>char</b></font>)<font color="#ff00ff">NULL</font>;
                clientsock-&gt;read(buffer,<font color="#ff00ff">5</font>);
                printf(<font color="#ff00ff">&quot;</font><font color="#6a5acd">%s</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,buffer);


                <font color="#0000ff">// write &quot;hello&quot; back to the client</font>
                clientsock-&gt;write(<font color="#ff00ff">&quot;hello&quot;</font>,<font color="#ff00ff">5</font>);


                <font color="#0000ff">// close the socket and clean up</font>
                clientsock-&gt;close();
                <font color="#a52a2a"><b>delete</b></font> clientsock;
        }
}
</pre>



</body>
</html>
