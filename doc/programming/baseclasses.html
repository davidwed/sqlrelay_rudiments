<html>
<head>
<title>firstworks   Programming with Rudiments using the Base Classes</title>
<link href="../css/styles.css" rel="stylesheet">
</head>
<body>

<span class="heading">Programming with Rudiments using the Base Classes</span><br><br>

<ul>
<li><a href="#daemon">Using the Daemon Class</a></li>
<li><a href="#errorhandler">Using the Error Handler Class</a></li>
<li><a href="#filedescriptor">Using the File Descriptor Class</a></li>
<li><a href="#file">Using the File Class</a></li>
<li><a href="#datatransport">Using the Data Transport Classes</a></li>
<li><a href="#server">Using the Server Socket Classes</a></li>
<li><a href="#client">Using the Client Socket Classes</a></li>
<li><a href="#complex">Using the Complex Socket Initialization methods of the Server Classes</a></li>
</ul>

<a name="daemon"></a>
<span class="heading">Using the Daemon Class</span><br><br>

<p>Here is some sample code for a daemon process that writes "hello" every 2
seconds.  Most daemons don't write anything to the console, but this one does
for purposes of demonstration.</p>

<PRE>
<FONT color=#a620f7>#include </FONT><FONT color=#ff00ff>&lt;rudiments/daemonprocess.h&gt;</FONT>
<FONT color=#a620f7>#include </FONT><FONT color=#ff00ff>&lt;iostream.h&gt;</FONT>
<FONT color=#a620f7>#include </FONT><FONT color=#ff00ff>&lt;unistd.h&gt;</FONT>
<FONT color=#a620f7>#include </FONT><FONT color=#ff00ff>&lt;stdlib.h&gt;</FONT>

<B><FONT color=#288a51>class</FONT></B> mydaemon: <B><FONT color=#a62828>public</FONT></B> daemonprocess {
        <B><FONT color=#a62828>public</FONT></B>:
                <B><FONT color=#288a51>void</FONT></B>    init();
                <B><FONT color=#288a51>void</FONT></B>    loop();
};

<B><FONT color=#288a51>void</FONT></B>    mydaemon::init() {
        runAsUser(<FONT color=#ff00ff>&quot;nobody&quot;</FONT>);
        runAsGroup(<FONT color=#ff00ff>&quot;nobody&quot;</FONT>);
        detach();
}

<B><FONT color=#288a51>void</FONT></B>    mydaemon::loop() {
        <B><FONT color=#a62828>for</FONT></B> (;;) {
                cout &lt;&lt; <FONT color=#ff00ff>&quot;hello&quot;</FONT> &lt;&lt; endl;
                sleep(<FONT color=#ff00ff>2</FONT>);
        }
}

mydaemon        *md;

<B><FONT color=#288a51>void</FONT></B>    shutDown() {
        <B><FONT color=#a62828>delete</FONT></B> md;
        exit(<FONT color=#ff00ff>0</FONT>);
}

main() {
        md=<B><FONT color=#a62828>new</FONT></B> mydaemon;
        md-&gt;handleShutDown((<B><FONT color=#288a51>void</FONT></B> *)shutDown);
        md-&gt;init();
        md-&gt;loop();
}
</PRE>


<a name="errorhandler"></a>
<span class="heading">Using the Error Handler Class</span><br><br>

<p>The errorhandler class provides simple error handling methods to any class.
To use the errorhandler class, your class should inherit from it.  Whenever
your class needs to generate an error, it can call the clearError() methods
and set the value of the protected "errorstr" strstream.  When a program needs
to get the error message, it can call the public getError() method.</p>

<p>The following program implements a file-handler class that generates errors
using methods from the errorhandler class.</p>

<PRE>
<font color="#a020f0">#include </font><font color="#f800f8">&lt;rudiments/errorhandler.h&gt;</font>
<font color="#a020f0">#include </font><font color="#f800f8">&lt;rudiments/permissions.h&gt;</font>
<font color="#a020f0">#include </font><font color="#f800f8">&lt;unistd.h&gt;</font>
<font color="#a020f0">#include </font><font color="#f800f8">&lt;sys/types.h&gt;</font>
<font color="#a020f0">#include </font><font color="#f800f8">&lt;sys/stat.h&gt;</font>
<font color="#a020f0">#include </font><font color="#f800f8">&lt;fcntl.h&gt;</font>
<font color="#a020f0">#include </font><font color="#f800f8">&lt;stdlib.h&gt;</font>
<font color="#a020f0">#include </font><font color="#f800f8">&lt;string.h&gt;</font>
<font color="#a020f0">#include </font><font color="#f800f8">&lt;iostream.h&gt;</font>

<font color="#288850"><b>class</b></font> fileclass : <font color="#a02828"><b>public</b></font> errorhandler {
        <font color="#a02828"><b>public</b></font>:
                <font color="#288850"><b>int</b></font>     openFile(<font color="#288850"><b>const</b></font> <font color="#288850"><b>char</b></font> *filename);
                ssize_t writeToFile(<font color="#288850"><b>const</b></font> <font color="#288850"><b>char</b></font> *data);
                ssize_t readFromFile(<font color="#288850"><b>char</b></font> *data, <font color="#288850"><b>size_t</b></font> length);
                <font color="#288850"><b>int</b></font>     closeFile();
        <font color="#a02828"><b>private</b></font>:
                <font color="#288850"><b>int</b></font>     fd;
};

<font color="#288850"><b>int</b></font>     fileclass::openFile(<font color="#288850"><b>const</b></font> <font color="#288850"><b>char</b></font> *filename) {

        <font color="#a02828"><b>if</b></font> (!(fd=open(filename,O_RDWR|O_CREAT,permissions::ownerReadWrite()))) {
                clearError();
                *errorstr &lt;&lt; <font color="#f800f8">&quot;error: open() failed&quot;</font> &lt;&lt; ends;
                <font color="#a02828"><b>return</b></font> <font color="#f800f8">0</font>;
        }
        <font color="#a02828"><b>return</b></font> <font color="#f800f8">1</font>;
}

ssize_t fileclass::writeToFile(<font color="#288850"><b>const</b></font> <font color="#288850"><b>char</b></font> *data) {

        <font color="#288850"><b>size_t</b></font>  length=strlen(data);
        ssize_t returnlength=<font color="#f800f8">0</font>;
        <font color="#a02828"><b>if</b></font> ((returnlength=write(fd,(<font color="#288850"><b>const</b></font> <font color="#288850"><b>void</b></font> *)data,length))!=length) {
                clearError();
                *errorstr &lt;&lt; <font color="#f800f8">&quot;error: write() failed&quot;</font> &lt;&lt; ends;
        }
        <font color="#a02828"><b>return</b></font> returnlength;
}

ssize_t fileclass::readFromFile(<font color="#288850"><b>char</b></font> *data, <font color="#288850"><b>size_t</b></font> length) {

        ssize_t returnlength=<font color="#f800f8">0</font>;
        <font color="#a02828"><b>if</b></font> ((returnlength=read(fd,(<font color="#288850"><b>void</b></font> *)data,length))!=length) {
                clearError();
                *errorstr &lt;&lt; <font color="#f800f8">&quot;error: read() failed&quot;</font> &lt;&lt; ends;
        }
        <font color="#a02828"><b>return</b></font> returnlength;
}

<font color="#288850"><b>int</b></font>     fileclass::closeFile() {

        <font color="#a02828"><b>if</b></font> (close(fd)==-<font color="#f800f8">1</font>) {
                clearError();
                *errorstr &lt;&lt; <font color="#f800f8">&quot;error: close() failed&quot;</font> &lt;&lt; ends;
                <font color="#a02828"><b>return</b></font> <font color="#f800f8">0</font>;
        }
        <font color="#a02828"><b>return</b></font> <font color="#f800f8">1</font>;
}

main() {

        fileclass       fc;
        <font color="#a02828"><b>if</b></font> (!fc.openFile(<font color="#f800f8">&quot;myfile&quot;</font>)) {
                cerr &lt;&lt; fc.getError() &lt;&lt; endl;
        }
        <font color="#a02828"><b>if</b></font> (fc.writeToFile(<font color="#f800f8">&quot;hello&quot;</font>)!=<font color="#f800f8">5</font>) {
                cerr &lt;&lt; fc.getError() &lt;&lt; endl;
        }
        <font color="#a02828"><b>if</b></font> (!fc.closeFile()) {
                cerr &lt;&lt; fc.getError() &lt;&lt; endl;
        }
        <font color="#a02828"><b>if</b></font> (!fc.openFile(<font color="#f800f8">&quot;myfile&quot;</font>)) {
                cerr &lt;&lt; fc.getError() &lt;&lt; endl;
        }
        <font color="#288850"><b>char</b></font>    data[<font color="#f800f8">6</font>];
        data[<font color="#f800f8">5</font>]=(<font color="#288850"><b>char</b></font>)<font color="#f800f8">NULL</font>;
        <font color="#a02828"><b>if</b></font> (fc.readFromFile(data,<font color="#f800f8">5</font>)!=<font color="#f800f8">5</font>) {
                cerr &lt;&lt; fc.getError() &lt;&lt; endl;
        }
        cout &lt;&lt; data &lt;&lt; endl;
        <font color="#a02828"><b>if</b></font> (!fc.closeFile()) {
                cerr &lt;&lt; fc.getError() &lt;&lt; endl;
        }
}
</PRE>

<a name="#filedescriptor">
<span class="heading">Using the File Descriptor Class</span><br><br>

<p>...</p>

<a name="#file">
<span class="heading">Using the File Class</span><br><br>

<p>...</p>

<a name="#datatransport">
<span class="heading">Using the Data Transport Classes</span><br><br>

<p>...</p>

<a name="server"></a>
<span class="heading">Using the Server Socket Classes</span><br><br>

<p>Daemons are commonly used to serve data to clients on the same machine or
over a network.  Below is an example combining the daemon and listener classes.
This server listens on unix and inet sockets for a client connection, receives
a string from the client and writes the same string back to the client.</p>

<PRE>
<font color="#a020f0">#include </font><font color="#f800f8">&lt;rudiments/daemonprocess.h&gt;</font>
<font color="#a020f0">#include </font><font color="#f800f8">&lt;rudiments/listener.h&gt;</font>
<font color="#a020f0">#include </font><font color="#f800f8">&lt;rudiments/unixserversocket.h&gt;</font>
<font color="#a020f0">#include </font><font color="#f800f8">&lt;rudiments/inetserversocket.h&gt;</font>
<font color="#a020f0">#include </font><font color="#f800f8">&lt;rudiments/transport.h&gt;</font>
<font color="#a020f0">#include </font><font color="#f800f8">&lt;unistd.h&gt;</font>
<font color="#a020f0">#include </font><font color="#f800f8">&lt;stdlib.h&gt;</font>
<font color="#a020f0">#include </font><font color="#f800f8">&lt;sys/stat.h&gt;</font>

<font color="#288850"><b>class</b></font> myserver: <font color="#a02828"><b>public</b></font> daemonprocess, <font color="#a02828"><b>public</b></font> listener {
        <font color="#a02828"><b>public</b></font>:
                        myserver();
                        ~myserver();
                <font color="#288850"><b>void</b></font>    loop();
                <font color="#288850"><b>void</b></font>    session();
        <font color="#a02828"><b>private</b></font>:
                unixserversocket        inetsocket;
                inetserversocket        unixsocket;
                transport               *sock;
};

myserver::myserver() : daemonprocess(), listener() {

        <font color="#0000f8">// run as a different user/group</font>
        runAsUser(<font color="#f800f8">&quot;nobody&quot;</font>);
        runAsGroup(<font color="#f800f8">&quot;nobody&quot;</font>);

        <font color="#0000f8">// detach from the controlling tty</font>
        detach();

        <font color="#0000f8">// open, bind and listen on an inet port and unix socket</font>
        inetsocket.listenOnSocket(<font color="#f800f8">NULL</font>,<font color="#f800f8">8040</font>,<font color="#f800f8">15</font>);
        unixsocket.listenOnSocket(<font color="#f800f8">&quot;/tmp/mysocket&quot;</font>,S_IRUSR|S_IWUSR,<font color="#f800f8">15</font>);

        <font color="#0000f8">// add the sockets to the pool</font>
        addFileDescriptor(inetsocket.getFileDescriptor());
        addFileDescriptor(unixsocket.getFileDescriptor());
}

myserver::~myserver() {
        inetsocket.close();
        unixsocket.close();
}

<font color="#288850"><b>void</b></font>    myserver::loop() {

        <font color="#a02828"><b>for</b></font> (;;) {

                <font color="#0000f8">// accept connections, with no timeout</font>
                <font color="#288850"><b>int</b></font>     fd=waitForData(-<font color="#f800f8">1</font>,-<font color="#f800f8">1</font>);

                <font color="#a02828"><b>if</b></font> (fd==inetsocket.getFileDescriptor()) {
                        sock=inetsocket.acceptClientConnection();
                } <font color="#a02828"><b>else</b></font> <font color="#a02828"><b>if</b></font> (fd==unixsocket.getFileDescriptor()) {
                        sock=unixsocket.acceptClientConnection();
                }

                <font color="#0000f8">// fork to handle the new connection</font>
                <font color="#a02828"><b>if</b></font> (!fork()) {

                        <font color="#0000f8">// close the duplicated server socket,</font>
                        <font color="#0000f8">// engage in a session with the client,</font>
                        <font color="#0000f8">// close the client socket and exit</font>
                        <font color="#a02828"><b>if</b></font> (fd==inetsocket.getFileDescriptor()) {
                                inetsocket.close();
                        } <font color="#a02828"><b>else</b></font> <font color="#a02828"><b>if</b></font> (fd==unixsocket.getFileDescriptor()) {
                                unixsocket.close();
                        }
                        session();
                        sock-&gt;close();
                        _exit(<font color="#f800f8">0</font>);
                }

                <font color="#0000f8">// close the client socket, but leave the server</font>
                <font color="#0000f8">// socket open to accept more connections</font>
                <font color="#a02828"><b>if</b></font> (fd==inetsocket.getFileDescriptor()) {
                        inetsocket.close();
                } <font color="#a02828"><b>else</b></font> <font color="#a02828"><b>if</b></font> (fd==unixsocket.getFileDescriptor()) {
                        unixsocket.close();
                }
        }
}

<font color="#288850"><b>void</b></font>    myserver::session() {

        <font color="#0000f8">// read a string from the client</font>
        <font color="#288850"><b>short</b></font>   bytes;
        sock-&gt;read(&amp;bytes);
        <font color="#288850"><b>char</b></font>    *string=<font color="#a02828"><b>new</b></font> <font color="#288850"><b>char</b></font>[bytes+<font color="#f800f8">1</font>];
        sock-&gt;read(string,bytes);

        <font color="#0000f8">// write the same string back to the client</font>
        sock-&gt;write(bytes);
        sock-&gt;write(string,bytes);

        <font color="#0000f8">// clean up</font>
        <font color="#a02828"><b>delete</b></font>[] string;
}


myserver        *ms;

<font color="#288850"><b>void</b></font>    shutDown() {
        <font color="#a02828"><b>delete</b></font> ms;
        exit(<font color="#f800f8">0</font>);
}

main() {
        ms=<font color="#a02828"><b>new</b></font> myserver();
        ms-&gt;handleShutDown((<font color="#288850"><b>void</b></font> *)shutDown);
        ms-&gt;loop();
}

</PRE>

<p>Notice that this server listens on both inet and unix ports.  Inet ports
allow clients and servers to talk across a network.  Unix ports allow clients
and servers on the same machine to talk through a pipe.  Though clients and
servers on the same machine could talk over inet ports, unix ports are much
faster and use fewer system resources.</p>

<a name="client"></a>
<span class="heading">Using the Client Socket Classes</span><br><br>

<p>Here's the code for a client that can talk to the server above.  This client
sends a string to the server, reads what the server sends back and prints it
out.  It does this once over an inet port and once over a unix port.</p>

<PRE>
<font color="#a020f0">#include </font><font color="#f800f8">&lt;rudiments/inetclientsocket.h&gt;</font>
<font color="#a020f0">#include </font><font color="#f800f8">&lt;rudiments/unixclientsocket.h&gt;</font>
<font color="#a020f0">#include </font><font color="#f800f8">&lt;iostream.h&gt;</font>

<font color="#288850"><b>class</b></font> myclient {
        <font color="#a02828"><b>public</b></font>:
                <font color="#288850"><b>void</b></font>    inetSession(<font color="#288850"><b>char</b></font> *host, <font color="#288850"><b>int</b></font> port, <font color="#288850"><b>char</b></font> *message);
                <font color="#288850"><b>void</b></font>    unixSession(<font color="#288850"><b>char</b></font> *socket, <font color="#288850"><b>char</b></font> *message);
        <font color="#a02828"><b>private</b></font>:
                <font color="#288850"><b>void</b></font>    session(transport *sock, <font color="#288850"><b>char</b></font> *message);
                inetclientsocket        inetsock;
                unixclientsocket        unixsock;
};

<font color="#288850"><b>void</b></font>    myclient::inetSession(<font color="#288850"><b>char</b></font> *host, <font color="#288850"><b>int</b></font> port, <font color="#288850"><b>char</b></font> *message) {
        inetsock.connectToServer(host,port,<font color="#f800f8">0</font>,<font color="#f800f8">1</font>);
        session(&amp;inetsock,message);
}

<font color="#288850"><b>void</b></font>    myclient::unixSession(<font color="#288850"><b>char</b></font> *socket, <font color="#288850"><b>char</b></font> *message) {
        unixsock.connectToServer(socket,<font color="#f800f8">0</font>,<font color="#f800f8">1</font>);
        session(&amp;unixsock,message);
}

<font color="#288850"><b>void</b></font>    myclient::session(transport *sock, <font color="#288850"><b>char</b></font> *message) {

        <font color="#0000f8">// write a message to the server</font>
        sock-&gt;write((<font color="#288850"><b>short</b></font>)strlen(message));
        sock-&gt;write(message);

        <font color="#0000f8">// read a message back from the server</font>
        <font color="#288850"><b>short</b></font>   bytes;
        sock-&gt;read(&amp;bytes);
        <font color="#288850"><b>char</b></font>    *string=<font color="#a02828"><b>new</b></font> <font color="#288850"><b>char</b></font>[bytes+<font color="#f800f8">1</font>];
        sock-&gt;read(string,bytes);

        <font color="#0000f8">// write out the message we got from the server</font>
        cout &lt;&lt; string &lt;&lt; endl;

        <font color="#0000f8">// clean up</font>
        <font color="#a02828"><b>delete</b></font>[] string;
}

main() {

        <font color="#0000f8">// declare an instance of our client</font>
        myclient        mc;

        <font color="#0000f8">// connect to a known inet host/port and unix socket and </font>
        <font color="#0000f8">// send a message over each connection</font>
        mc.inetSession(<font color="#f800f8">&quot;localhost&quot;</font>,<font color="#f800f8">8040</font>,<font color="#f800f8">&quot;message over inet port&quot;</font>);
        mc.unixSession(<font color="#f800f8">&quot;/tmp/mysocket&quot;</font>,<font color="#f800f8">&quot;message over unix port&quot;</font>);
}

</PRE>

<a name="complex"></a>
<span class="heading">Using the Complex Socket Initialization methods of the
Server Classes</span><br><br>

<p>Setting up a server to listen on a socket is actually a multi-step process. 
The listenOnSocket() methods simplify this process but some applications may
require a more flexible interface.  If you need to set socket options or
perform additional actions between the steps of socket initialization, you can
use the Complex Socket Inititalization methods of the server classes.</p>

<p>Below is an alternative implementation of the myserver constructor in
which some socket options are set.</p>

<PRE>
myserver::myserver() : daemonprocess(), listener() {

        <FONT color=#0000ff>// run as a different user/group</FONT>
        runAsUser(<FONT color=#ff00ff>&quot;nobody&quot;</FONT>);
        runAsGroup(<FONT color=#ff00ff>&quot;nobody&quot;</FONT>);

        <FONT color=#0000ff>// detach from the controlling tty</FONT>
        detach();

        <FONT color=#0000ff>// initialize the ports</FONT>
        inetsocket.initInetServerSocket(<FONT color=#ff00ff>NULL</FONT>,<FONT color=#ff00ff>8040</FONT>);
        unixsocket.initUnixServerSocket(<FONT color=#ff00ff>&quot;/tmp/mysocket&quot;</FONT>,S_IRUSR|S_IWUSR,<FONT color=#ff00ff>15</FONT>);

        <FONT color=#0000ff>// set some socket options</FONT>
        inetsocket.lingerOnClose(<FONT color=#ff00ff>10</FONT>);
        inetsocket.reuseAddresses();
        unixsocket.lingerOnClose(<FONT color=#ff00ff>10</FONT>);

        <FONT color=#0000ff>// bind to the ports</FONT>
        inetsocket.bind();
        unixsocket.bind();

        <FONT color=#0000ff>// listen on the ports</FONT>
        inetsocket.listen(<FONT color=#ff00ff>15</FONT>);
        unixsocket.listen(<FONT color=#ff00ff>15</FONT>);

        <FONT color=#0000ff>// add sockets to the pool</FONT>
        addFileDescriptor(inetsocket.getFileDescriptor());
        addFileDescriptor(unixsocket.getFileDescriptor());
}
</PRE>

</body>
</html>
