






<pre>
<font color="#0000ff">// Copyright (c) 2001  David Muse</font>
<font color="#0000ff">// See the file COPYING for more information</font>

<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/listener.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/inetserversocket.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/unixserversocket.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/permissions.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;stdio.h&gt;</font>

<font color="#a020f0">#ifdef RUDIMENTS_NAMESPACE</font>
<font color="#a52a2a"><b>using</b></font> <font color="#2e8b57"><b>namespace</b></font> rudiments;
<font color="#a020f0">#endif</font>

<font color="#2e8b57"><b>int</b></font> main(<font color="#2e8b57"><b>int</b></font> argc, <font color="#2e8b57"><b>const</b></font> <font color="#2e8b57"><b>char</b></font> **argv) {


        <font color="#0000ff">// listen on inet socket port 1800</font>
        inetserversocket        inetsock;
        <font color="#a52a2a"><b>if</b></font> (!inetsock.listen(<font color="#ff00ff">NULL</font>,<font color="#ff00ff">8000</font>,<font color="#ff00ff">15</font>)) {
                printf(<font color="#ff00ff">&quot;couldn't listen on inet socket</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>);
        }


        <font color="#0000ff">// listen on unix socket &quot;/tmp/lsnr.socket&quot;</font>
        unixserversocket        unixsock;
        <font color="#a52a2a"><b>if</b></font> (!unixsock.listen(<font color="#ff00ff">&quot;/tmp/lsnr.socket&quot;</font>,<font color="#a020f0">0</font><font color="#ff00ff">000</font>,<font color="#ff00ff">15</font>)) {
                printf(<font color="#ff00ff">&quot;couldn't listen on unix socket</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>);
        }


        <font color="#0000ff">// create a listener and add the 2 sockets to it</font>
        listener        pool;
        pool.addFileDescriptor(&amp;inetsock);
        pool.addFileDescriptor(&amp;unixsock);


        <font color="#0000ff">// loop...</font>
        <font color="#a52a2a"><b>for</b></font> (;;) {

                <font color="#0000ff">// wait for a client to connect to one of the sockets</font>
                pool.waitForNonBlockingRead(-<font color="#ff00ff">1</font>,-<font color="#ff00ff">1</font>);
                filedescriptor  *fd=<font color="#ff00ff">NULL</font>;
                pool.getReadyList()-&gt;getDataByIndex(<font color="#ff00ff">0</font>,&amp;fd);

                <font color="#0000ff">// figure out which socket the client connected to</font>
                filedescriptor  *clientsock;
                <font color="#a52a2a"><b>if</b></font> (fd==&amp;inetsock) {
                        clientsock=inetsock.accept();
                        printf(<font color="#ff00ff">&quot;inetsock: &quot;</font>);
                } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (fd==&amp;unixsock) {
                        clientsock=unixsock.accept();
                        printf(<font color="#ff00ff">&quot;unixsock: &quot;</font>);
                } <font color="#a52a2a"><b>else</b></font> {
                        printf(<font color="#ff00ff">&quot;error or timeout waiting...</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>);
                        <font color="#a52a2a"><b>continue</b></font>;
                }


                <font color="#0000ff">// read 5 bytes from the client and display it</font>
                <font color="#2e8b57"><b>char</b></font>  buffer[<font color="#ff00ff">6</font>];
                buffer[<font color="#ff00ff">5</font>]=(<font color="#2e8b57"><b>char</b></font>)<font color="#ff00ff">NULL</font>;
                clientsock-&gt;read(buffer,<font color="#ff00ff">5</font>);
                printf(<font color="#ff00ff">&quot;</font><font color="#6a5acd">%s</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,buffer);


                <font color="#0000ff">// write &quot;hello&quot; back to the client</font>
                clientsock-&gt;write(<font color="#ff00ff">&quot;hello&quot;</font>,<font color="#ff00ff">5</font>);


                <font color="#0000ff">// close the socket and clean up</font>
                clientsock-&gt;close();
                <font color="#a52a2a"><b>delete</b></font> clientsock;
        }
}
</pre>


