






<pre>
<font color="#0000ff">// Copyright (c) 2001  David Muse</font>
<font color="#0000ff">// See the file COPYING for more information</font>

<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/daemonprocess.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/permissions.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/process.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/file.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;rudiments/snooze.h&gt;</font>

<font color="#a020f0">#include </font><font color="#ff00ff">&lt;stdlib.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;sys/types.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;unistd.h&gt;</font>
<font color="#a020f0">#include </font><font color="#ff00ff">&lt;stdio.h&gt;</font>

<font color="#a020f0">#ifdef RUDIMENTS_NAMESPACE</font>
<font color="#a52a2a"><b>using</b></font> <font color="#2e8b57"><b>namespace</b></font> rudiments;
<font color="#a020f0">#endif</font>

daemonprocess   *dmn;

<font color="#0000ff">// define a function to shut down the process cleanly</font>
RETSIGTYPE      shutDown() {

        printf(<font color="#ff00ff">&quot;</font><font color="#6a5acd">%d</font><font color="#ff00ff">: shutting down</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,process::getProcessId());

        <font color="#0000ff">// clean up</font>
        <font color="#a52a2a"><b>delete</b></font> dmn;
        file::remove(<font color="#ff00ff">&quot;/tmp/dmn.pidfile&quot;</font>);
        exit(<font color="#ff00ff">0</font>);
}

<font color="#2e8b57"><b>int</b></font> main(<font color="#2e8b57"><b>int</b></font> argc, <font color="#2e8b57"><b>const</b></font> <font color="#2e8b57"><b>char</b></font> **argv) {

        dmn=<font color="#a52a2a"><b>new</b></font> daemonprocess();

        <font color="#0000ff">// set up signal handlers for clean shutdown</font>
        dmn-&gt;handleShutDown((RETSIGTYPE *)shutDown);
        dmn-&gt;handleCrash((RETSIGTYPE *)shutDown);

        <font color="#0000ff">// change the user/group that the daemon is running as</font>
        dmn-&gt;runAsUser(<font color="#ff00ff">&quot;nobody&quot;</font>);
        dmn-&gt;runAsGroup(<font color="#ff00ff">&quot;nobody&quot;</font>);

        <font color="#0000ff">// make sure that only one instance is running</font>
        <font color="#2e8b57"><b>int</b></font>    pid=dmn-&gt;checkForPidFile(<font color="#ff00ff">&quot;/tmp/dmn.pidfile&quot;</font>);
        <font color="#a52a2a"><b>if</b></font> (pid&gt;-<font color="#ff00ff">1</font>) {
                printf(<font color="#ff00ff">&quot;Sorry, an instance of this daemon is already running with process id: </font><font color="#6a5acd">%d</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,pid);
                <font color="#a52a2a"><b>delete</b></font> dmn;
                exit(<font color="#ff00ff">0</font>);
        }

        <font color="#0000ff">// detach from the controlling terminal</font>
        dmn-&gt;detach();

        <font color="#0000ff">// create a pid file which is used to make sure that only one instance</font>
        <font color="#0000ff">// is running and can also be used to kill the process</font>
        dmn-&gt;createPidFile(<font color="#ff00ff">&quot;/tmp/dmn.pidfile&quot;</font>,permissions::ownerReadWrite());

        <font color="#a52a2a"><b>if</b></font> (!fork()) {
                <font color="#a52a2a"><b>for</b></font> (;;) {
                        printf(<font color="#ff00ff">&quot;</font><font color="#6a5acd">%d</font><font color="#ff00ff">: child looping...</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,
                                process::getProcessId());
                        snooze::macrosnooze(<font color="#ff00ff">1</font>);
                }
        }

        <font color="#0000ff">// loop, printing &quot;looping...&quot; once per second</font>
        <font color="#a52a2a"><b>for</b></font> (;;) {
                printf(<font color="#ff00ff">&quot;</font><font color="#6a5acd">%d</font><font color="#ff00ff">: parent looping...</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>,
                                process::getProcessId());
                snooze::macrosnooze(<font color="#ff00ff">1</font>);
        }
}
</pre>


