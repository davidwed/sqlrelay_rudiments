<html>
<head>
<title>/usr/local/src/rudiments-0.25/include/rudiments/semaphoreset.h.html</title>
<meta name="Generator" content="Vim/6.1">
</head>
<body bgcolor="#ffffff" text="#000000">
<pre>
<font color="#0000f8">// Copyright (c) 1999-2002 David Muse</font>
<font color="#0000f8">// See the COPYING file for more information.</font>

<font color="#a020f0">#ifndef RUDIMENTS_SEMAPHORESET_H</font>
<font color="#a020f0">#define RUDIMENTS_SEMAPHORESET_H</font>

<font color="#a020f0">#include </font><font color="#f800f8">&lt;rudiments/private/config.h&gt;</font>

<font color="#a020f0">#include </font><font color="#f800f8">&lt;sys/types.h&gt;</font>

<font color="#0000f8">// Semaphores allow processes to synchronize their activities.</font>
<font color="#0000f8">//</font>
<font color="#0000f8">// A semaphore is just a number with two primary operations that can be </font>
<font color="#0000f8">// performed on it: signal() and wait()</font>
<font color="#0000f8">// </font>
<font color="#0000f8">// The operations are analagous to:</font>
<font color="#0000f8">//</font>
<font color="#0000f8">// int  semaphore;</font>
<font color="#0000f8">//</font>
<font color="#0000f8">// void signal() {</font>
<font color="#0000f8">//      semaphore++;            // increment the semaphore</font>
<font color="#0000f8">// }</font>
<font color="#0000f8">//</font>
<font color="#0000f8">// void wait() {</font>
<font color="#0000f8">//      while (!semaphore&gt;0);   // wait until the semaphore&gt;0</font>
<font color="#0000f8">//      semaphore--;            // decrement the semaphore</font>
<font color="#0000f8">// }</font>
<font color="#0000f8">//</font>
<font color="#0000f8">// The actual signal() and wait() operations are atomic.  There is no chance </font>
<font color="#0000f8">// of another process getting context-switched in and changing the semaphore </font>
<font color="#0000f8">// value between the two lines of code in the wait() process.</font>
<font color="#0000f8">//</font>
<font color="#0000f8">// Semaphores can be initialized to any number.</font>
<font color="#0000f8">// </font>
<font color="#0000f8">// The initial value of the semaphore corresponds to the number of processes</font>
<font color="#0000f8">// that will pass directly through their wait() calls without being blocked.</font>
<font color="#0000f8">//</font>
<font color="#0000f8">// Processes that get blocked calling wait() are placed in a queue.  When </font>
<font color="#0000f8">// another process calls signal(), the process at the head of the queue is </font>
<font color="#0000f8">// unblocked.</font>
<font color="#0000f8">//</font>
<font color="#0000f8">// A semaphoreset is just a collection of related semaphores.</font>
<font color="#0000f8">//</font>
<font color="#0000f8">// A semaphoreset is owned by a user and group and has access permissions</font>
<font color="#0000f8">// just like a file.</font>

<font color="#288850"><b>class</b></font> semaphoreset {
        <font color="#a02828"><b>public</b></font>:
                        semaphoreset();
                                <font color="#0000f8">// Creates a semaphore set.</font>
                <font color="#288850"><b>virtual</b></font> ~semaphoreset();
                                <font color="#0000f8">// Cleans up and removes the semaphore set</font>
                                <font color="#0000f8">// if it was created by create() or </font>
                                <font color="#0000f8">// createOrAttach() below.  If the semaphore</font>
                                <font color="#0000f8">// was just attached to, it is not removed.</font>

                <font color="#288850"><b>int</b></font>     create(key_t key, mode_t permissions,
                                        <font color="#288850"><b>int</b></font> semcount, <font color="#288850"><b>const</b></font> <font color="#288850"><b>int</b></font> *values);
                                <font color="#0000f8">// Creates a semaphore set identified by &quot;key&quot;</font>
                                <font color="#0000f8">//      containing &quot;semcount&quot; semaphores.</font>
                                <font color="#0000f8">// &quot;key&quot; should be generated using the ftok </font>
                                <font color="#0000f8">//      function. </font>
                                <font color="#0000f8">// &quot;permissions&quot; sets the access permissions</font>
                                <font color="#0000f8">//      for the set.</font>
                                <font color="#0000f8">// &quot;values&quot; should be an array of starting </font>
                                <font color="#0000f8">//      values for each of the semaphores </font>
                                <font color="#0000f8">//      in the set.</font>
                <font color="#288850"><b>int</b></font>     attach(key_t key, <font color="#288850"><b>int</b></font> semcount);
                                <font color="#0000f8">// Attaches to an already existing semaphore set</font>
                                <font color="#0000f8">// identified by &quot;key&quot;, containing &quot;semcount&quot; </font>
                                <font color="#0000f8">// semaphores.</font>
                <font color="#288850"><b>int</b></font>     createOrAttach(key_t key, mode_t permissions,
                                        <font color="#288850"><b>int</b></font> semcount, <font color="#288850"><b>const</b></font> <font color="#288850"><b>int</b></font> *values);
                                <font color="#0000f8">// Attempts to create the semaphore set </font>
                                <font color="#0000f8">// identified by &quot;key&quot;.  If this fails, it </font>
                                <font color="#0000f8">// attempts to attach to a semaphore set</font>
                                <font color="#0000f8">// identified by &quot;key&quot;.</font>

                <font color="#288850"><b>void</b></font>    dontRemove();
                        <font color="#0000f8">// Instructs the destructor not to remove the semaphore</font>
                        <font color="#0000f8">// set if it was created during a call to create() or </font>
                        <font color="#0000f8">// createOrAttach() above.  This is useful if an </font>
                        <font color="#0000f8">// application creates a semaphore set then forks and </font>
                        <font color="#0000f8">// wants to delete the semaphore set in the forked </font>
                        <font color="#0000f8">// process but does not want the semaphore removed from</font>
                        <font color="#0000f8">// the system.</font>
                <font color="#288850"><b>int</b></font>     forceRemove();
                        <font color="#0000f8">// Removes the semaphore set, whether it</font>
                        <font color="#0000f8">// was created or attached to.</font>

                <font color="#288850"><b>int</b></font>     getId() <font color="#288850"><b>const</b></font>;
                        <font color="#0000f8">// Returns the internal id for the semaphore set.</font>

                <font color="#288850"><b>int</b></font>     wait(<font color="#288850"><b>int</b></font> index);
                        <font color="#0000f8">// wait on the &quot;index&quot;'th semaphore in the set</font>
                <font color="#288850"><b>int</b></font>     signal(<font color="#288850"><b>int</b></font> index);
                        <font color="#0000f8">// signal on the &quot;index&quot;'th semaphore in the set</font>


                <font color="#288850"><b>int</b></font>     waitWithUndo(<font color="#288850"><b>int</b></font> index);
                        <font color="#0000f8">// wait on the &quot;index&quot;'th semaphore in the set and</font>
                        <font color="#0000f8">// undo the wait when the program exits</font>
                <font color="#288850"><b>int</b></font>     signalWithUndo(<font color="#288850"><b>int</b></font> index);
                        <font color="#0000f8">// signal on the &quot;index&quot;'th semaphore in the set and</font>
                        <font color="#0000f8">// undo the signal when the program exits</font>


                <font color="#288850"><b>int</b></font>     setValue(<font color="#288850"><b>int</b></font> index, <font color="#288850"><b>int</b></font> value);
                        <font color="#0000f8">// set the &quot;index&quot;'th semaphore in the set to &quot;value&quot;</font>
                <font color="#288850"><b>int</b></font>     getValue(<font color="#288850"><b>int</b></font> index);
                        <font color="#0000f8">// return the value of the &quot;index&quot;'th </font>
                        <font color="#0000f8">// semaphore in the set</font>


                <font color="#288850"><b>int</b></font>     setUserName(<font color="#288850"><b>const</b></font> <font color="#288850"><b>char</b></font> *username);
                        <font color="#0000f8">// Makes this semaphore set owned by </font>
                        <font color="#0000f8">// the user &quot;username&quot;.</font>
                        <font color="#0000f8">//      </font>
                        <font color="#0000f8">// Note that setUserName() uses the passwdentry class.</font>
                        <font color="#0000f8">// If you are using this method in a multithreaded</font>
                        <font color="#0000f8">// application, you may need to supply the passwdentry</font>
                        <font color="#0000f8">// class a mutex.  See passwdentry.h for more detail.</font>
                <font color="#288850"><b>int</b></font>     setGroupName(<font color="#288850"><b>const</b></font> <font color="#288850"><b>char</b></font> *groupname);
                        <font color="#0000f8">// Makes this semaphore set owned by </font>
                        <font color="#0000f8">// the group &quot;groupname&quot;.</font>
                        <font color="#0000f8">//      </font>
                        <font color="#0000f8">// Note that setGroupName() uses the groupentry class.</font>
                        <font color="#0000f8">// If you are using this method in a multithreaded</font>
                        <font color="#0000f8">// application, you may need to supply the groupentry</font>
                        <font color="#0000f8">// class a mutex.  See groupentry.h for more detail.</font>

                <font color="#288850"><b>int</b></font>     setUserId(uid_t uid);
                        <font color="#0000f8">// makes this semaphore set owned by </font>
                        <font color="#0000f8">// the user identified by &quot;uid&quot;</font>
                <font color="#288850"><b>int</b></font>     setGroupId(gid_t gid);
                        <font color="#0000f8">// makes this semaphore set owned by </font>
                        <font color="#0000f8">// the group identified by &quot;gid&quot;</font>
                <font color="#288850"><b>int</b></font>     setPermissions(mode_t permissions);
                        <font color="#0000f8">// sets the access permissions for this </font>
                        <font color="#0000f8">// semaphore set to &quot;permissions&quot;</font>


                <font color="#288850"><b>char</b></font>    *getUserName();
                        <font color="#0000f8">// returns the name of the user that owns this</font>
                        <font color="#0000f8">// semaphore set</font>
                        <font color="#0000f8">//</font>
                        <font color="#0000f8">// Note that this method allocates a buffer</font>
                        <font color="#0000f8">// internally and returns it.  The calling program must</font>
                        <font color="#0000f8">// deallocate this buffer.</font>
                        <font color="#0000f8">//      </font>
                        <font color="#0000f8">// Note that getUserName() uses the passwdentry class.</font>
                        <font color="#0000f8">// If you are using this method in a multithreaded</font>
                        <font color="#0000f8">// application, you may need to supply the passwdentry</font>
                        <font color="#0000f8">// class a mutex.  See passwdentry.h for more detail.</font>
                <font color="#288850"><b>char</b></font>    *getGroupName();
                        <font color="#0000f8">// returns the name of the group that owns this</font>
                        <font color="#0000f8">// semaphore set</font>
                        <font color="#0000f8">//</font>
                        <font color="#0000f8">// Note that this method allocates a buffer</font>
                        <font color="#0000f8">// internally and returns it.  The calling program must</font>
                        <font color="#0000f8">// deallocate this buffer.</font>
                        <font color="#0000f8">//      </font>
                        <font color="#0000f8">// Note that getGroupName() uses the groupentry class.</font>
                        <font color="#0000f8">// If you are using this method in a multithreaded</font>
                        <font color="#0000f8">// application, you may need to supply the groupentry</font>
                        <font color="#0000f8">// class a mutex.  See groupentry.h for more detail.</font>

                uid_t   getUserId();
                        <font color="#0000f8">// returns the user id of the user that owns this</font>
                        <font color="#0000f8">// semaphore set</font>
                gid_t   getGroupId();
                        <font color="#0000f8">// returns the group id of the group that owns this</font>
                        <font color="#0000f8">// semaphore set</font>
                mode_t  getPermissions();
                        <font color="#0000f8">// returns the access permissions for this</font>
                        <font color="#0000f8">// semaphore set</font>


                <font color="#288850"><b>int</b></font>     getWaitingForZero(<font color="#288850"><b>int</b></font> index);
                        <font color="#0000f8">// returns the number of processes that</font>
                        <font color="#0000f8">// are waiting for the semaphore to become 0</font>
                <font color="#288850"><b>int</b></font>     getWaitingForIncrement(<font color="#288850"><b>int</b></font> index);
                        <font color="#0000f8">// returns the number of processes that</font>
                        <font color="#0000f8">// are waiting for the semaphore to increment</font>

<font color="#a020f0">        #include </font><font color="#f800f8">&lt;rudiments/private/semaphoreset.h&gt;</font>

};

<font color="#a020f0">#ifdef ENABLE_INLINES</font>
<font color="#a020f0">        #include </font><font color="#f800f8">&lt;rudiments/private/semaphoresetinlines.h&gt;</font>
<font color="#a020f0">#endif</font>

<font color="#a020f0">#endif</font>
</pre>
</body>
</html>
