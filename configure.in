dnl Process this file with autoconf to produce a configure script.
AC_INIT(src/daemonprocess.C)


AC_ARG_ENABLE(small-code,
	[  --enable-small-code     optimize for small code size],
	SMALLCODE="-O -Os",
	SMALLCODE="")
AC_ARG_WITH(system-libtool,
	[  --with-system-libtool   use system libtool instead of ./libtool],
	USE_SYSTEM_LIBTOOL=$withval,
	USE_SYSTEM_LIBTOOL="no")
AC_ARG_ENABLE(inlines,
	[  --enable-inlines        use inline methods],
	ENABLE_INLINES="yes",
	ENABLE_INLINES="no")
AC_ARG_WITH(ptheads-prefix,
	[  --with-ptheads-prefix         Location of Pthreads],
	PTHREADSPATH=$withval,
	PTHREADSPATH="")


CXXFLAGS="-fomit-frame-pointer -fno-exceptions"
DEBUGCXXFLAGS="-fno-exceptions"
AC_SUBST(CXXFLAGS)
AC_SUBST(DEBUGCXXFLAGS)
AC_SUBST(SMALLCODE)
if ( test -n "$SMALLCODE" ); then
	AC_DEFINE_UNQUOTED(SMALL_CODE,1,Use small rather than fast code)
fi



dnl Additional defines.
AH_TEMPLATE([socklen_t],[Some systems don't define socklen_t])
AH_TEMPLATE([HAVE_SEMUN],[Some systems define union semun])
AH_TEMPLATE([HAVE_CMSGHDR],[Some systems define struct cmsghdr])
AH_TEMPLATE([SIGNAL_HANDLER_INT],[Most systems define signal handlers with an integer parameter])
AH_TEMPLATE([HAVE_CMSG_SPACE],[Some systems don't define CMSG_SPACE])
AH_TEMPLATE([ENABLE_INLINES],[Use inline functions or not])
if ( test "$ENABLE_INLINES" = "yes" ); then
	AC_DEFINE_UNQUOTED(ENABLE_INLINES,1,Use inline functions or not)
fi



dnl Checks for libtool.
echo
echo "***** Libtool ****************"
AC_LIBTOOL_WIN32_DLL
AC_PROG_LIBTOOL
FW_CHECK_USE_SYSTEM_LIBTOOL
echo "******************************"



dnl Checks for programs.
echo
echo "***** Programs ***************"
AC_PROG_CXX
AC_PROG_CC
AC_PROG_CPP
AC_PROG_INSTALL
AC_PROG_LN_S
AC_PROG_MAKE_SET
AC_LANG(C++)

dnl have to set ar here because libtool (currently) fails
dnl to use the correct one when cross-compiling
AC_CHECK_PROG(AR,$host_alias-ar,$host_alias-ar,ar)
AC_SUBST(AR)

FW_CHECK_GNU_STRIP
FW_CHECK_PIPE
echo "******************************"


dnl Checks for header files.
echo
echo "***** Headers ****************"
AC_HEADER_DIRENT
AC_HEADER_STDC
AC_HEADER_SYS_WAIT
AC_CHECK_HEADERS([arpa/inet.h fcntl.h limits.h netdb.h netinet/in.h stddef.h stdlib.h string.h strings.h sys/socket.h sys/time.h syslog.h unistd.h regex.h regexp.h libgen.h regexpr.h sys/times.h sys/select.h])
echo "******************************"


dnl Checks for thread library.
echo
echo "***** threads ****************"
FW_CHECK_PTHREADS
echo "******************************"


dnl Checks for typedefs, structures, and compiler characteristics.
echo
echo "***** Structures *************"
AC_C_CONST
AC_TYPE_UID_T
AC_C_INLINE
AC_TYPE_MODE_T
AC_TYPE_PID_T
AC_TYPE_SIZE_T
AC_MSG_CHECKING(for socklen_t)
AC_EGREP_CPP(socklen_t,[#include <sys/socket.h>],AC_MSG_RESULT(yes),AC_MSG_RESULT(no); AC_DEFINE(socklen_t, int, Some systems don't define socklen_t))
AC_MSG_CHECKING(for union semun)
AC_EGREP_CPP(union semun,[#include <sys/sem.h>],AC_DEFINE(HAVE_SEMUN,1, Some systems define union semun) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))
AC_MSG_CHECKING(for struct cmsghdr)
AC_EGREP_CPP(struct cmsghdr,[#include <sys/socket.h>],AC_DEFINE(HAVE_CMSGHDR,1, Some systems define struct cmsghdr) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))
AC_MSG_CHECKING(for CMSG_SPACE)
AC_TRY_LINK([#include <sys/socket.h>],
int a; a=CMSG_SPACE(sizeof(int));,AC_DEFINE(HAVE_CMSG_SPACE, 1, Some systems don't define CMSG_SPACE) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))
AC_MSG_CHECKING(if struct stat contains st_blksize)
AC_TRY_LINK([#include <sys/types.h>
#include <sys/stat.h>
#include <unistd.h>],
struct stat st;
blksize_t s=st.st_blksize;,AC_DEFINE(HAVE_BLKSIZE_T, 1, Some systems don't have st_blksize in struct stat) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))
AC_MSG_CHECKING(if struct stat contains st_blocks)
AC_TRY_LINK([#include <sys/types.h>
#include <sys/stat.h>
#include <unistd.h>],
struct stat st;
blkcnt_t b=st.st_blocks;,AC_DEFINE(HAVE_BLKCNT_T, 1, Some systems don't have st_blocks in struct stat) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))
AC_MSG_CHECKING(if S_ISSOCK exists)
AC_TRY_LINK([#include <sys/types.h>
#include <sys/stat.h>
#include <unistd.h>],
S_ISSOCK(0);,AC_DEFINE(HAVE_S_ISSOCK, 1, Some systems don't have S_ISSOCK) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))
AC_MSG_CHECKING(type of iovec.iov_base)
AC_TRY_LINK([#include <sys/types.h>
#include <sys/socket.h>],
struct iovec iov; iov.iov_base=(void *)" ";,AC_DEFINE(IOV_BASE_TYPE,void *,iov_base is void *) AC_MSG_RESULT(void *), AC_DEFINE(IOV_BASE_TYPE,char *,iov_base is char *) AC_MSG_RESULT(char *))
echo "******************************"


dnl Checks associated with signal handlers
echo
echo "***** Signal Handlers ********"
AC_TYPE_SIGNAL
AC_MSG_CHECKING(signal handler parameter)
AC_TRY_LINK([#include <signal.h>],
void (*handler)(int); struct sigaction test; test.sa_handler=handler;,AC_DEFINE(SIGNAL_HANDLER_INT, 1, Most systems define signal handlers with an integer parameter) AC_MSG_RESULT(int),AC_MSG_RESULT(void))
echo "******************************"


dnl Checks associated with time structure
echo
echo "***** Time Structure *********"
AC_HEADER_TIME
AC_STRUCT_TM
AC_STRUCT_TIMEZONE
AC_MSG_CHECKING(tm_zone)
AC_EGREP_CPP(tm_zone,[#include <time.h>],AC_DEFINE(HAS_TM_ZONE,1, Some systems define tm_zone in their struct tm) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))

AC_MSG_CHECKING(tm_gmtoff)
AC_EGREP_CPP(tm_gmtoff,[#include <time.h>],AC_DEFINE(HAS_TM_GMTOFF,1, Some systems define tm_gmtoff in their struct tm) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))

AC_MSG_CHECKING(__tm_zone)
AC_EGREP_CPP(__tm_zone,[#include <time.h>],AC_DEFINE(HAS___TM_ZONE,1, Some systems define __tm_zone in their struct tm) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))

AC_MSG_CHECKING(__tm_gmtoff)
AC_EGREP_CPP(__tm_gmtoff,[#include <time.h>],AC_DEFINE(HAS___TM_GMTOFF,1, Some systems define __tm_gmtoff in their struct tm) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))

AC_MSG_CHECKING(tm_name)
AC_EGREP_CPP(tm_name,[#include <time.h>],AC_DEFINE(HAS_TM_NAME,1, Some systems define tm_name in their struct tm) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))

AC_MSG_CHECKING(tm_tzadj)
AC_EGREP_CPP(tm_tzadj,[#include <time.h>],AC_DEFINE(HAS_TM_TZADJ,1, Some systems define tm_tzadj in their struct tm) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))

AC_MSG_CHECKING(real-time-clock support)
AC_TRY_LINK([#include <linux/rtc.h>
#include <sys/ioctl.h>],
ioctl(0,RTC_RD_TIME,0);,AC_DEFINE(HAVE_RTC, 1, Do we have a real-time-clock) AC_MSG_RESULT(yes),AC_MSG_RESULT(no))

AC_MSG_CHECKING(localtime_r)
AC_TRY_LINK([#include <time.h>,
#include <stdlib.h>],
localtime_r(NULL,NULL);,AC_DEFINE(HAVE_LOCALTIME_R,1, Some systems have localtime_r) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))

echo "******************************"


dnl Checks for library functions.
echo
echo "***** Functions **************"
AC_LANG(C)
AC_FUNC_FORK
AC_FUNC_MALLOC
AC_FUNC_MKTIME
AC_CHECK_FUNCS(regcomp regcmp re_comp sem_open setenv putenv unsetenv)

AC_MSG_CHECKING(srand48)
AC_TRY_LINK([#include <stdlib.h>],
srand48(0);,AC_DEFINE(HAVE_SRAND48,1, Some systems have srand48) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))

AC_MSG_CHECKING(lrand48)
AC_TRY_LINK([#include <stdlib.h>],
lrand48();,AC_DEFINE(HAVE_LRAND48,1, Some systems have lrand48) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))

AC_MSG_CHECKING(srand)
AC_TRY_LINK([#include <stdlib.h>],
srand(0);,AC_DEFINE(HAVE_SRAND,1, Some systems have srand) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))

AC_MSG_CHECKING(rand)
AC_TRY_LINK([#include <stdlib.h>],
rand();,AC_DEFINE(HAVE_RAND,1, Some systems have rand) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))

AC_CHECK_LIB(socket,socket,SOCKETLIB=-lsocket,SOCKETLIB="")
AC_SUBST(SOCKETLIB)
AC_CHECK_LIB(xnet,gethostbyname,XNETLIB=-lxnet,XNETLIB="")
AC_SUBST(XNETLIB)
AC_CHECK_LIB(nsl,gethostbyname,NSLLIB=-lnsl,NSLLIB="")
AC_SUBST(NSLLIB)

OLDLIBS="$LIBS"
LIBS="$LIBS $SOCKETLIB $XNETLIB $NSLLIB"

AC_LANG(C++)
AC_MSG_CHECKING(getpwnam_r)
AC_TRY_LINK([#include <pwd.h>
#include <stdlib.h>],
getpwnam_r(NULL,NULL,NULL,0,NULL);,AC_DEFINE(HAVE_GETPWNAM_R,1, Some systems have getpwnam_r) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))

AC_MSG_CHECKING(getpwuid_r)
AC_TRY_LINK([#include <pwd.h>
#include <stdlib.h>],
getpwuid_r(0,NULL,NULL,0,NULL);,AC_DEFINE(HAVE_GETPWUID_R,1, Some systems have getpwuid_r) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))

AC_MSG_CHECKING(getgrnam_r)
AC_TRY_LINK([#include <grp.h>
#include <stdlib.h>],
getgrnam_r(NULL,NULL,NULL,0,NULL);,AC_DEFINE(HAVE_GETGRNAM_R,1, Some systems have getgrnam_r) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))

AC_MSG_CHECKING(getgrgid_r)
AC_TRY_LINK([#include <grp.h>
#include <stdlib.h>],
getgrgid_r(0,NULL,NULL,0,NULL);,AC_DEFINE(HAVE_GETGRGID_R,1, Some systems have getgrgid_r) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))

AC_MSG_CHECKING(getaddrinfo)
AC_TRY_LINK([#include <netdb.h>
#include <stdlib.h>],
getaddrinfo(NULL,NULL,NULL,NULL);,AC_DEFINE(HAVE_GETADDRINFO,1, Some systems have getaddrinfo) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))

AC_MSG_CHECKING(gethostbyname_r)
AC_TRY_LINK([#include <netdb.h>
#include <stdlib.h>],
gethostbyname_r(NULL,NULL,NULL,0,NULL,NULL);,AC_DEFINE(HAVE_GETHOSTBYNAME_R,1, Some systems have gethostbyname_r) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))

AC_MSG_CHECKING(gethostbyaddr_r)
AC_TRY_LINK([#include <netdb.h>
#include <stdlib.h>],
gethostbyaddr_r(NULL,0,0,NULL,NULL,0,NULL,NULL);,AC_DEFINE(HAVE_GETHOSTBYADDR_R,1, Some systems have gethostbyaddr_r) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))

AC_MSG_CHECKING(getprotobyname_r)
AC_TRY_LINK([#include <netdb.h>
#include <stdlib.h>],
getprotobyname_r(NULL,NULL,NULL,0,NULL);,AC_DEFINE(HAVE_GETPROTOBYNAME_R,1, Some systems have getprotobyname_r) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))

AC_MSG_CHECKING(getprotobynumber_r)
AC_TRY_LINK([#include <netdb.h>
#include <stdlib.h>],
getprotobynumber_r(0,NULL,NULL,0,NULL);,AC_DEFINE(HAVE_GETPROTOBYNUMBER_R,1, Some systems have getprotobynumber_r) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))

AC_MSG_CHECKING(getspnam_r)
AC_TRY_LINK([#include <shadow.h>
#include <stdlib.h>],
getspnam_r(NULL,NULL,NULL,0,NULL);,AC_DEFINE(HAVE_GETSPNAM_R,1, Some systems have getspnam_r) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))

AC_MSG_CHECKING(getservbyname_r)
AC_TRY_LINK([#include <netdb.h>
#include <stdlib.h>],
getservbyname_r(NULL,NULL,NULL,NULL,0,NULL);,AC_DEFINE(HAVE_GETSERVBYNAME_R,1, Some systems have getservbyname_r) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))

AC_MSG_CHECKING(getservbyport_r)
AC_TRY_LINK([#include <netdb.h>
#include <stdlib.h>],
getservbyport_r(0,NULL,NULL,NULL,0,NULL);,AC_DEFINE(HAVE_GETSERVBYPORT_R,1, Some systems have getservbyport_r) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))

HAVE_GETRPCBYNAME_R="no"
AC_MSG_CHECKING(getrpcbyname_r)
AC_TRY_LINK([#include <netdb.h>
#include <stdlib.h>],
getrpcbyname_r(NULL,NULL,NULL,0,NULL);,HAVEGETRPCBYNAME_R="yes"; AC_DEFINE(HAVE_GETRPCBYNAME_R,1, Some systems have getrpcbyname_r) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))

if ( test "$HAVEGETRPCBYNAME_R" = "no" )
then
AC_MSG_CHECKING(getrpcbyname_r)
AC_TRY_LINK([#include <netdb.h>
#include <stdlib.h>
#include <rpc/rpcent.h>],
getrpcbyname_r(NULL,NULL,NULL,0,NULL);,HAVEGETRPCBYNAME_R="yes"; AC_DEFINE(HAVE_GETRPCBYNAME_R,1, Some systems have getrpcbyname_r) AC_DEFINE(HAVE_RPCENT_H,1, Some systems have rpc/rpcent.h) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))
fi

if ( test "$HAVEGETRPCBYNAME_R" = "no" )
then
AC_MSG_CHECKING(getrpcbyname_r)
AC_TRY_LINK([#include <netdb.h>
#include <stdlib.h>
#include <rpc/rpc.h>],
getrpcbyname_r(NULL,NULL,NULL,0,NULL);,HAVEGETRPCBYNAME_R="yes"; AC_DEFINE(HAVE_GETRPCBYNAME_R,1, Some systems have getrpcbyname_r) AC_DEFINE(HAVE_RPC_H,1, Some systems have rpc/rpc.h) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))
fi

HAVEGETRPCBYNUMBER_R="no"
AC_MSG_CHECKING(getrpcbynumber_r)
AC_TRY_LINK([#include <netdb.h>
#include <stdlib.h>],
getrpcbynumber_r(0,NULL,NULL,0,NULL);,HAVEGETRPCBYNUMBER_R="yes"; AC_DEFINE(HAVE_GETRPCBYNUMBER_R,1, Some systems have getrpcbynumber_r) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))

if ( test "$HAVE_GETRPCBYNUMBER_R" = "no" )
then
AC_MSG_CHECKING(getrpcbynumber_r)
AC_TRY_LINK([#include <netdb.h>
#include <stdlib.h>
#include <rpc/rpcent.h>],
getrpcbynumber_r(0,NULL,NULL,0,NULL);,HAVEGETRPCBYNUMBER_R="yes"; AC_DEFINE(HAVE_GETRPCBYNUMBER_R,1, Some systems have getrpcbynumber_r) AC_DEFINE(HAVE_RPCENT_H,1, Some systems have rpc/rpcent.h) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))
fi

if ( test "$HAVE_GETRPCBYNUMBER_R" = "no" )
then
AC_MSG_CHECKING(getrpcbynumber_r)
AC_TRY_LINK([#include <netdb.h>
#include <stdlib.h>
#include <rpc/rpc.h>],
getrpcbynumber_r(0,NULL,NULL,0,NULL);,HAVEGETRPCBYNUMBER_R="yes"; AC_DEFINE(HAVE_GETRPCBYNUMBER_R,1, Some systems have getrpcbynumber_r) AC_DEFINE(HAVE_RPC_H,1, Some systems have rpc/rpc.h) AC_MSG_RESULT(yes), AC_MSG_RESULT(no))
fi

LIBS="$OLDLIBS"

echo "******************************"


FW_CHECK_MICROSOFT


dnl Default build variables.
RUDIMENTS_VERSION="0.26"
AC_SUBST(RUDIMENTS_VERSION)
AC_DEFINE_UNQUOTED(RUDIMENTS_VERSION,"$RUDIMENTS_VERSION",Version)
dnl rules for CURRENT:REVISION:AGE version info:
dnl apply the following rules in order:
dnl if library source changed at all,         c:r:a -> c:r+1:a
dnl if interfaces added, removed, or changed, c:r:a -> c+1:0:a
dnl if interfaces added,                      c:r:a -> c:r:a+1
dnl if interfaces removed,                    c:r:a -> c:r:0
SONAME_VERSION_INFO="1:0:0"
AC_SUBST(SONAME_VERSION_INFO)
AC_PREFIX_DEFAULT(/usr/local/firstworks)


dnl Output files.
echo
echo "***** Output Files ***********"
AC_CONFIG_HEADER(include/rudiments/private/config.h)
AC_CONFIG_SRCDIR(test/xmls.C)
AC_CONFIG_FILES(config.mk bin/rudiments-config)
AC_OUTPUT
chmod 755 bin/rudiments-config
echo "******************************"
echo
